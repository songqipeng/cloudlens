# 📥 账单自动获取 - 快速说明

> 通过阿里云BSS OpenAPI自动获取账单数据，无需手动下载CSV

---

## 🎯 核心优势

| 对比项 | 手动下载 | 自动获取 ✨ |
|--------|---------|------------|
| 操作步骤 | 登录控制台→下载→解压→整理 | 一行命令 |
| 时效性 | 需要手动触发 | 定时自动 |
| 数据完整性 | ✅ | ✅ 完全一致 |
| 适合场景 | 临时查看 | 产品化使用 |

---

## 🚀 快速开始（3步）

### 1. 安装依赖

```bash
pip install aliyun-python-sdk-core aliyun-python-sdk-bssopenapi python-dateutil
```

### 2. 测试连接

```bash
# 测试API是否正常（获取5条样本数据）
./cl bill test --account my_account
```

**预期输出**：
```
✅ 成功获取 5 条记录

📋 样本数据（第1条记录）
├─ 产品名称: 云服务器 ECS
├─ 计费方式: Subscription  
├─ 官网价: 100.00
├─ 折扣: 50.00
└─ 应付金额: 50.00

✅ API连接正常，可以执行完整获取
```

### 3. 获取账单

```bash
# 获取最近3个月的账单（默认）
./cl bill fetch --account my_account

# 或指定时间范围
./cl bill fetch --account my_account --start 2025-01 --end 2025-06
```

**结果**：
```
✅ 成功获取 3 个月份的账单数据

┌────────┬──────────────────────┬─────────┐
│ 账期   │ 文件路径              │ 文件大小│
├────────┼──────────────────────┼─────────┤
│ 2025-10│ bills_data/.../      │ 65.32 MB│
│ 2025-11│ bills_data/.../      │ 67.18 MB│
│ 2025-12│ bills_data/.../      │ 68.45 MB│
└────────┴──────────────────────┴─────────┘

💡 提示:
  运行折扣分析: ./cl analyze discount
  在Web页面刷新即可看到最新数据
```

---

## 🔧 配置定时任务

### 每月自动获取上月账单

```bash
# 编辑crontab
crontab -e

# 添加定时任务（每月1号1点执行）
0 1 1 * * cd /path/to/aliyunidle && ./cl bill fetch --account my_account
```

---

## 💡 使用场景

### 1. 月度折扣分析

```bash
# 自动获取账单
./cl bill fetch --account my_account

# 分析折扣趋势
./cl analyze discount --export --format excel

# Web查看可视化结果
open http://localhost:3000/discounts
```

### 2. 实时监控

```python
# scripts/monitor.py
from core.bill_fetcher import BillFetcher
from datetime import datetime

fetcher = BillFetcher(access_key_id, access_key_secret)
current_month = datetime.now().strftime("%Y-%m")

# 每天自动获取当月数据
records = fetcher.fetch_instance_bill(current_month)
# 分析并告警...
```

---

## 🔒 权限配置

### RAM权限

账号需要以下权限：
- `bss:QueryInstanceBill` - 查询实例账单明细  
- `bss:QueryBillOverview` - 查询账单概览

### 授权步骤

1. 登录阿里云控制台
2. 进入"访问控制（RAM）"
3. 选择RAM用户
4. 添加"AliyunBSSFullAccess"权限策略

---

## 📊 数据说明

### CSV文件内容

自动获取的CSV与手动下载**完全一致**：

- ✅ 76个字段（包含所有明细）
- ✅ 官网价、优惠金额、应付金额
- ✅ 产品、实例、地域信息
- ✅ 代金券、储值卡抵扣
- ✅ 合同编号、优惠名称

### 与折扣分析集成

```
自动获取账单CSV
  ↓
保存到 bills_data/
  ↓
折扣分析自动识别
  ↓
Web页面显示结果
```

---

## 🛠️ 常见问题

### Q1: 需要哪些依赖？

```bash
pip install aliyun-python-sdk-core aliyun-python-sdk-bssopenapi python-dateutil
```

### Q2: 如何验证权限？

```bash
./cl bill test --account my_account
```

如果显示"权限不足"，需要在RAM中添加BSS权限。

### Q3: 数据保存在哪里？

默认保存在 `bills_data/{账号ID}-{账号名}/` 目录。

可通过 `--output-dir` 参数自定义：
```bash
./cl bill fetch --account my_account --output-dir ./my_bills
```

### Q4: 如何与Web页面集成？

1. 自动获取账单后，Web折扣分析会自动识别新数据
2. 访问 http://localhost:3000/discounts
3. 点击"强制刷新"即可看到最新分析

---

## 📚 详细文档

完整功能说明和最佳实践，请查看：
- **完整指南**: docs/BILL_AUTO_FETCH_GUIDE.md
- **API文档**: core/bill_fetcher.py
- **折扣分析**: docs/DISCOUNT_ANALYSIS_GUIDE.md

---

## 🎉 核心价值

### 产品化的正确方式

- ✅ **自动化**: 一行命令，定时执行
- ✅ **实时性**: 随时获取最新数据
- ✅ **可靠性**: 数据与控制台完全一致
- ✅ **易用性**: 3步完成配置
- ✅ **可扩展**: 支持定时任务、监控告警

### ROI提升

- 手动下载: 10分钟/次 × 12次/年 = 2小时/年
- 自动获取: 5分钟配置 = **节省95%时间**

---

**创建时间**: 2025-12-15  
**功能状态**: ✅ 完整实现  
**立即开始**: `./cl bill test --account my_account`
