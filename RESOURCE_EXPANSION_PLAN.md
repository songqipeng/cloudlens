# 资源类型扩展与折扣分析完整规划

> **报告日期**: 2025-10-30  
> **版本**: v2.3.0

---

## 📊 当前状态分析

### 1. CRU分析（资源利用率分析）

| 资源类型 | 状态 | 分析器文件 | 折扣分析状态 |
|---------|------|-----------|------------|
| **ECS** | ✅ | `ecs_analyzer.py` | ✅ 已支持 |
| **RDS** | ✅ | `rds_analyzer.py` | ✅ 已支持 |
| **Redis** | ✅ | `redis_analyzer.py` | 🚧 90%（需完善） |
| **MongoDB** | ✅ | `mongodb_analyzer.py` | 🚧 90%（需完善） |
| **ClickHouse** | ✅ | `clickhouse_analyzer.py` | ❌ 未支持 |
| **OSS** | ✅ | `oss_analyzer.py` | ❌ 未支持 |
| **SLB** | ✅ | `slb_analyzer.py` | ❌ 未支持 |
| **EIP** | ✅ | `eip_analyzer.py` | ❌ 未支持 |

### 2. 折扣分析支持情况

**已完全支持**：
- ✅ ECS - 使用 `DescribeRenewalPrice` API
- ✅ RDS - 使用 `DescribeRenewalPrice` API

**部分支持**：
- 🚧 Redis - 使用 `DescribePrice` API（90%完成）
- 🚧 MongoDB - 使用 `DescribePrice` API（90%完成）

**未支持**：
- ❌ ClickHouse - 需要实现
- ❌ OSS - 通常按量付费，可能不支持包年包月
- ❌ SLB - 通常按量付费，可能不支持包年包月
- ❌ EIP - 通常按量付费，可能不支持包年包月

---

## 🚀 可扩展的资源类型

### 1. 高优先级扩展（支持包年包月，适合折扣分析）

#### 1.1 ClickHouse（云数据库ClickHouse版）

**扩展理由**：
- ✅ 支持包年包月付费模式
- ✅ 有 `DescribeRenewalPrice` 或 `DescribePrice` API
- ✅ 已有CRU分析器，只需补充折扣分析

**实施计划**：
```python
# resource_modules/discount_analyzer.py 中添加
def analyze_clickhouse_discounts(self, output_base_dir='.'):
    """分析ClickHouse折扣"""
    # 1. 获取所有ClickHouse实例（包年包月）
    # 2. 调用DescribeRenewalPrice API
    # 3. 计算折扣率
    # 4. 生成报告
```

**优先级**: 🔴 P0（高）

---

#### 1.2 NAS（文件存储NAS）

**扩展理由**：
- ✅ 支持包年包月付费模式
- ✅ 有存储容量和性能规格，适合分析
- 📋 需要新建CRU分析器和折扣分析

**监控指标**：
- 存储容量使用率
- IOPS使用率
- 吞吐量
- 文件数量

**折扣分析**：
- 容量费用折扣
- 性能规格折扣

**优先级**: 🟠 P1（中高）

---

#### 1.3 ACK（容器服务Kubernetes版）

**扩展理由**：
- ✅ 支持包年包月节点付费
- ✅ Master节点和管理节点有包年包月选项
- 📋 需要新建CRU分析器和折扣分析

**监控指标**：
- 节点CPU/内存使用率
- Pod资源使用率
- 集群规模

**折扣分析**：
- 节点续费折扣
- 管理节点折扣

**优先级**: 🟠 P1（中高）

---

#### 1.4 ECI（弹性容器实例）

**扩展理由**：
- ✅ 支持包年包月预留实例
- ✅ 有ECI预留实例券
- 📋 需要新建CRU分析器和折扣分析

**监控指标**：
- 实例运行时长
- 资源配置
- 预留实例利用率

**折扣分析**：
- 预留实例券折扣
- 按需转预留成本分析

**优先级**: 🟡 P2（中）

---

### 2. 中优先级扩展（按量付费为主，可选折扣分析）

#### 2.1 CDN（内容分发网络）

**扩展理由**：
- ✅ 支持流量包（预付费）
- ✅ 有流量包折扣
- 📋 需要新建CRU分析器

**监控指标**：
- 流量使用量
- 请求数
- 带宽峰值
- 流量包利用率

**折扣分析**：
- 流量包购买折扣
- 按流量付费 vs 流量包对比

**优先级**: 🟡 P2（中）

---

#### 2.2 VPN（VPN网关）

**扩展理由**：
- ✅ 支持包年包月付费
- ✅ 有固定带宽规格
- 📋 需要新建CRU分析器

**监控指标**：
- 带宽使用率
- 连接数
- 流量

**折扣分析**：
- 续费折扣分析

**优先级**: 🟡 P2（中）

---

#### 2.3 NAT（NAT网关）

**扩展理由**：
- ✅ 支持包年包月付费
- ✅ 有规格选择
- 📋 需要新建CRU分析器

**监控指标**：
- 带宽使用率
- 连接数
- 流量

**折扣分析**：
- 续费折扣分析

**优先级**: 🟡 P2（中）

---

#### 2.4 RDS for PostgreSQL/MySQL（其他数据库类型）

**扩展理由**：
- ✅ RDS已有分析器，但主要针对MySQL
- ✅ PostgreSQL等也有包年包月
- 📋 可复用RDS分析器逻辑

**优先级**: 🟢 P3（低）

---

### 3. 低优先级扩展（按量付费为主）

#### 3.1 OSS（对象存储） - 折扣分析补充

**当前状态**：已有CRU分析器，不支持折扣分析

**分析**：
- OSS主要按量付费（存储+流量+请求）
- 支持资源包（存储包、流量包、请求包）
- 可分析资源包折扣和利用率

**折扣分析方案**：
```python
# OSS折扣分析（基于资源包）
def analyze_oss_discounts(self, output_base_dir='.'):
    """分析OSS资源包折扣"""
    # 1. 获取OSS Bucket列表
    # 2. 获取已购买的资源包
    # 3. 分析资源包利用率
    # 4. 计算资源包折扣
    # 5. 生成优化建议（按量 vs 资源包）
```

**优先级**: 🟡 P2（中）- 资源包折扣分析

---

#### 3.2 SLB（负载均衡） - 折扣分析补充

**当前状态**：已有CRU分析器，不支持折扣分析

**分析**：
- SLB通常按量付费
- 高规格SLB可能支持包年包月
- 可分析流量包折扣

**优先级**: 🟢 P3（低）- 如有包年包月选项

---

#### 3.3 EIP（弹性公网IP） - 折扣分析补充

**当前状态**：已有CRU分析器，不支持折扣分析

**分析**：
- EIP主要按量付费
- 固定带宽EIP可能支持包年包月
- 可分析带宽包折扣

**优先级**: 🟢 P3（低）- 如有包年包月选项

---

### 4. 新兴资源类型

#### 4.1 Serverless（函数计算FC）

**扩展理由**：
- ✅ 有预留实例（包年包月）
- ✅ 按量付费为主，但有预留实例折扣
- 📋 需要新建CRU分析器

**优先级**: 🟡 P2（中）

---

#### 4.2 PolarDB（云原生数据库）

**扩展理由**：
- ✅ 支持包年包月
- ✅ 有类似RDS的价格结构
- 📋 需要新建CRU分析器和折扣分析

**优先级**: 🟡 P2（中）

---

#### 4.3 AnalyticDB（分析型数据库）

**扩展理由**：
- ✅ 支持包年包月
- ✅ 按计算和存储分别计费
- 📋 需要新建CRU分析器和折扣分析

**优先级**: 🟡 P2（中）

---

## 📋 折扣分析完整实现计划

### 阶段1：完善现有资源折扣分析（P0 - 立即执行）

#### 1.1 完善Redis折扣分析 ✅

**当前状态**：90%完成，需修复API调用问题

**待完成**：
- [x] 修复DescribePrice API调用
- [ ] 完善错误处理
- [ ] 优化折扣计算逻辑

**预计时间**：1-2天

---

#### 1.2 完善MongoDB折扣分析 ✅

**当前状态**：90%完成，需修复API调用问题

**待完成**：
- [x] 修复DescribePrice API调用
- [ ] 完善错误处理
- [ ] 优化折扣计算逻辑

**预计时间**：1-2天

---

#### 1.3 实现ClickHouse折扣分析 🔴

**当前状态**：未实现

**实施步骤**：
1. 在 `discount_analyzer.py` 中添加 `analyze_clickhouse_discounts()` 方法
2. 调用 `DescribeRenewalPrice` API（ClickHouse属于DDS系列）
3. 处理ClickHouse特有的参数（节点数、存储容量等）
4. 生成折扣报告

**API参考**：
```python
# ClickHouse使用DDS API的DescribeRenewalPrice
request.set_domain(f'dds.{region}.aliyuncs.com')
request.set_action_name('DescribeRenewalPrice')
request.add_query_param('DBInstanceId', instance_id)
request.add_query_param('Period', 1)  # 1个月
```

**预计时间**：2-3天

---

### 阶段2：资源包折扣分析（P1 - 近期执行）

#### 2.1 OSS资源包折扣分析

**分析内容**：
- 存储包利用率
- 流量包利用率
- 请求包利用率
- 资源包 vs 按量付费成本对比

**实施步骤**：
1. 获取OSS Bucket列表
2. 获取已购买的资源包信息
3. 分析资源包使用情况
4. 计算资源包折扣和节省

**预计时间**：3-5天

---

### 阶段3：新增资源类型折扣分析（P1-P2 - 中期执行）

#### 3.1 NAS折扣分析
- 容量包折扣
- 性能包折扣
- 预计时间：3-5天

#### 3.2 ACK折扣分析
- 节点续费折扣
- 管理节点折扣
- 预计时间：3-5天

---

## 🎯 实施优先级总览

### P0 - 高优先级（立即执行，1-2周）

| 任务 | 资源类型 | 工作量 | 状态 |
|------|---------|--------|------|
| 完善Redis折扣分析 | Redis | 1-2天 | 🚧 90% |
| 完善MongoDB折扣分析 | MongoDB | 1-2天 | 🚧 90% |
| 实现ClickHouse折扣分析 | ClickHouse | 2-3天 | ❌ 未实现 |

**目标**：确保所有已有CRU分析的资源类型都有完整的折扣分析

---

### P1 - 中高优先级（近期执行，1个月内）

| 任务 | 资源类型 | 工作量 | 状态 |
|------|---------|--------|------|
| OSS资源包折扣分析 | OSS | 3-5天 | ❌ 未实现 |
| NAS资源CRU+折扣分析 | NAS | 5-7天 | ❌ 未实现 |
| ACK资源CRU+折扣分析 | ACK | 5-7天 | ❌ 未实现 |

---

### P2 - 中优先级（中期执行，3个月内）

| 任务 | 资源类型 | 工作量 |
|------|---------|--------|
| ECI资源CRU+折扣分析 | ECI | 5-7天 |
| CDN资源包折扣分析 | CDN | 3-5天 |
| VPN折扣分析 | VPN | 3-5天 |
| NAT折扣分析 | NAT | 3-5天 |

---

## 📝 实施建议

### 1. 立即行动项（本周）

1. **完善Redis折扣分析**（1-2天）
   - 修复API调用问题
   - 完善错误处理
   - 测试验证

2. **完善MongoDB折扣分析**（1-2天）
   - 修复API调用问题
   - 完善错误处理
   - 测试验证

### 2. 短期行动项（2周内）

3. **实现ClickHouse折扣分析**（2-3天）
   - 添加 `analyze_clickhouse_discounts()` 方法
   - 调用DescribeRenewalPrice API
   - 生成折扣报告

### 3. 中期行动项（1个月内）

4. **OSS资源包折扣分析**（3-5天）
5. **NAS资源完整支持**（5-7天）

---

## 🔍 阿里云API支持情况

### 支持续费折扣的API

| 资源类型 | API | 版本 | 状态 |
|---------|-----|------|------|
| ECS | `DescribeRenewalPrice` | 2014-05-26 | ✅ |
| RDS | `DescribeRenewalPrice` | 2014-08-15 | ✅ |
| Redis | `DescribePrice` (OrderType=RENEW) | 2015-01-01 | ✅ |
| MongoDB | `DescribePrice` (OrderType=RENEW) | 2015-12-01 | ✅ |
| ClickHouse | `DescribeRenewalPrice` | 2019-11-11 | ✅ |
| NAS | `DescribeRenewalPrice` | 2017-06-26 | ✅ |
| ACK | 节点续费价格（通过ECS） | - | ✅ |

---

## ✅ 总结

### 当前能力
- **CRU分析**: 8种资源类型 ✅
- **折扣分析**: 2种完全支持，2种90%完成 ❌

### 目标能力
- **CRU分析**: 12+种资源类型
- **折扣分析**: **所有支持包年包月的资源类型都要有折扣分析** ✅

### 优先级建议
1. **立即完成**: Redis、MongoDB折扣分析完善
2. **短期完成**: ClickHouse折扣分析实现
3. **中期完成**: NAS、ACK等新资源类型支持

---

**文档版本**: v1.0  
**最后更新**: 2025-10-30

