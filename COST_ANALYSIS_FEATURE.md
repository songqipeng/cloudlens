# 费用分析功能说明

> **完成日期**: 2025-10-30  
> **版本**: v2.4.1

---

## ✅ 新增功能

### 费用分布分析模块

新增 `resource_modules/cost_analyzer.py` 模块，支持：

1. **多维度费用统计**
   - 按资源类型汇总费用
   - 按区域汇总费用
   - 实例级别费用明细

2. **数据来源**
   - 优先使用折扣分析器的实际续费价格（更准确）
   - 备用：从数据库获取成本估算

3. **报告生成**
   - HTML可视化报告（带图表）
   - Excel详细数据报告

---

## 🚀 使用方法

```bash
# 分析ydzn租户的费用分布
python main.py ydzn cost

# 分析默认租户的费用分布
python main.py cost
```

---

## 📊 报告内容

### 1. 总体统计
- 总实例数
- 月度总成本
- 年度预估成本

### 2. 按资源类型分布
- 排名、资源类型、实例数
- 月度成本、占比
- 可视化占比条

### 3. 按区域分布
- 排名、区域
- 月度成本、占比
- 可视化占比条

### 4. 费用优化建议
- 重点关注资源（占比>20%）
- 区域优化建议
- 实例优化建议

---

## 📝 技术实现

### 成本数据获取策略

1. **包年包月资源**（优先使用实际价格）
   - ECS, RDS, Redis, MongoDB, ClickHouse, NAS, PolarDB
   - 通过 `DiscountAnalyzer.get_renewal_prices()` 获取实际续费价格

2. **按量付费资源**（使用估算成本）
   - OSS, SLB, EIP, ACK, ECI
   - 从数据库的 `monthly_cost` 字段获取

---

## 🔍 分析示例

分析ydzn租户费用分布：

```
💰 ydzn 月度费用分布分析
================================================================================

📊 总体统计:
  • 总实例数: 150 个
  • 月度总成本: ¥125,000.00
  • 年度预估成本: ¥1,500,000.00

📈 按资源类型分布（Top 10）:
排名   资源类型        实例数        月度成本           占比
-----------------------------------------------------------------
1      ECS            50            ¥75,000.00      60.00%
2      RDS            30            ¥30,000.00      24.00%
3      Redis          20            ¥15,000.00      12.00%
...

🌍 按区域分布（Top 10）:
排名   区域                  月度成本           占比
--------------------------------------------------
1      cn-hangzhou          ¥60,000.00      48.00%
2      cn-beijing           ¥35,000.00      28.00%
...
```

---

## 📁 输出文件

- **HTML报告**: `{tenant_name}/cost/{tenant_name}_cost_distribution_{timestamp}.html`
- **Excel报告**: `{tenant_name}/cost/{tenant_name}_cost_distribution_{timestamp}.xlsx`

---

**文档版本**: v1.0  
**最后更新**: 2025-10-30

