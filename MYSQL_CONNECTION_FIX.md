# MySQL è¿æ¥æ•°è¿‡å¤šé—®é¢˜ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-12-30  
**é—®é¢˜**: "1040 (08004): Too many connections"  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## é—®é¢˜æè¿°

åœ¨æŸ¥è¯¢æ‰€æœ‰28ä¸ªå¯ç”¨åŒºåŸŸæ—¶ï¼Œç³»ç»Ÿåˆ›å»ºäº†è¿‡å¤šçš„MySQLè¿æ¥ï¼Œè¶…è¿‡äº†MySQLçš„æœ€å¤§è¿æ¥æ•°é™åˆ¶ï¼ˆ151ä¸ªï¼‰ï¼Œå¯¼è‡´é”™è¯¯ã€‚

## æ ¹æœ¬åŸå› 

1. **è¿æ¥æ± é‡å¤åˆ›å»º**: æ¯æ¬¡åˆ›å»º `CacheManager` æˆ– `DatabaseAdapter` æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºæ–°çš„è¿æ¥æ± 
2. **è¿æ¥æ± å¤§å°è¿‡å¤§**: æ¯ä¸ªè¿æ¥æ± é»˜è®¤20ä¸ªè¿æ¥ï¼Œå¤šä¸ªè¿æ¥æ± å¯¼è‡´æ€»è¿æ¥æ•°è¿‡å¤š
3. **è¿æ¥æœªå¤ç”¨**: ç›¸åŒé…ç½®çš„æ•°æ®åº“é€‚é…å™¨æ²¡æœ‰å¤ç”¨ï¼Œæ¯æ¬¡éƒ½åˆ›å»ºæ–°å®ä¾‹

## ä¿®å¤å†…å®¹

### 1. å¢åŠ  MySQL æœ€å¤§è¿æ¥æ•°

```sql
SET GLOBAL max_connections = 500;
```

### 2. ä¼˜åŒ– DatabaseFactory ä½¿ç”¨å•ä¾‹æ¨¡å¼

**æ–‡ä»¶**: `core/database.py`

**æ”¹åŠ¨**:
- âœ… æ·»åŠ é€‚é…å™¨ç¼“å­˜ `_adapters`
- âœ… ç›¸åŒé…ç½®çš„é€‚é…å™¨ä¼šå¤ç”¨ï¼Œä¸å†é‡å¤åˆ›å»ºè¿æ¥æ± 
- âœ… å‡å°‘è¿æ¥æ± å¤§å°ä»20åˆ°10ï¼ˆå› ä¸ºä¼šå¤ç”¨ï¼‰

**å…³é”®ä»£ç **:
```python
class DatabaseFactory:
    """æ•°æ®åº“å·¥å‚ç±»ï¼ˆå•ä¾‹æ¨¡å¼ï¼Œå¤ç”¨è¿æ¥æ± ï¼‰"""
    
    _adapters = {}  # ç¼“å­˜å·²åˆ›å»ºçš„é€‚é…å™¨å®ä¾‹
    
    @staticmethod
    def create_adapter(db_type: Optional[str] = None, **kwargs) -> DatabaseAdapter:
        # ç”Ÿæˆç¼“å­˜é”®
        cache_key = f"{db_type}:{host}:{port}:{database}"
        
        # å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼ˆå¤ç”¨è¿æ¥æ± ï¼‰
        if cache_key in DatabaseFactory._adapters:
            return DatabaseFactory._adapters[cache_key]
        
        # åˆ›å»ºæ–°é€‚é…å™¨å¹¶ç¼“å­˜
        adapter = MySQLAdapter(mysql_config)
        DatabaseFactory._adapters[cache_key] = adapter
        return adapter
```

### 3. ä¼˜åŒ–è¿æ¥æ± é…ç½®

- âœ… è¿æ¥æ± å¤§å°: 20 â†’ 10ï¼ˆå› ä¸ºä¼šå¤ç”¨ï¼‰
- âœ… è¿æ¥è¶…æ—¶: è®¾ç½® `wait_timeout = 300` ç§’
- âœ… ç¡®ä¿è¿æ¥æ­£ç¡®å…³é—­å’Œå½’è¿˜

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- MySQLæœ€å¤§è¿æ¥æ•°: 151
- å®é™…è¿æ¥æ•°: 152+ (è¶…è¿‡é™åˆ¶)
- é”™è¯¯: "Too many connections"

### ä¿®å¤å
- MySQLæœ€å¤§è¿æ¥æ•°: 500
- è¿æ¥æ± å¤ç”¨: âœ… ç›¸åŒé…ç½®å¤ç”¨åŒä¸€ä¸ªè¿æ¥æ± 
- è¿æ¥æ± å¤§å°: 10 (ä¼˜åŒ–å)
- é¢„æœŸè¿æ¥æ•°: < 50 (å³ä½¿æŸ¥è¯¢æ‰€æœ‰28ä¸ªåŒºåŸŸ)

## éªŒè¯æ–¹æ³•

### æ£€æŸ¥è¿æ¥æ•°
```bash
mysql -u root -e "SHOW STATUS LIKE 'Threads_connected';"
```

### æ£€æŸ¥æœ€å¤§è¿æ¥æ•°
```bash
mysql -u root -e "SHOW VARIABLES LIKE 'max_connections';"
```

### æµ‹è¯•æ‰«æåŠŸèƒ½
åœ¨Webç•Œé¢ç‚¹å‡»"ç«‹å³æ‰«æ"æŒ‰é’®ï¼Œåº”è¯¥ä¸å†å‡ºç°è¿æ¥æ•°è¿‡å¤šé”™è¯¯ã€‚

## åç»­ä¼˜åŒ–å»ºè®®

1. **è¿æ¥æ± ç›‘æ§**: æ·»åŠ è¿æ¥æ± ä½¿ç”¨æƒ…å†µç›‘æ§
2. **è¿æ¥æ³„æ¼æ£€æµ‹**: å®šæœŸæ£€æŸ¥æœªå…³é—­çš„è¿æ¥
3. **åŠ¨æ€è°ƒæ•´**: æ ¹æ®å®é™…è´Ÿè½½åŠ¨æ€è°ƒæ•´è¿æ¥æ± å¤§å°

---

**ä¿®å¤å®Œæˆï¼ç°åœ¨å¯ä»¥æ­£å¸¸æŸ¥è¯¢æ‰€æœ‰åŒºåŸŸçš„èµ„æºäº†ã€‚** ğŸ‰




