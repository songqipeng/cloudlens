# CloudLens 开发进度梳理

**梳理时间**: 2026-01-24  
**基准**: `main` 分支最近提交 + 工作区未提交变更 + 2026 规划与测试报告

---

## 一、版本与仓库状态

| 项 | 状态 |
|----|------|
| **当前分支** | `main` |
| **最近提交** | `128d43e` - feat(terraform): 添加AWS部署配置和修复user-data脚本 |
| **未提交变更** | 约 30+ 个修改/新增/删除文件（见下方） |
| **未跟踪文件** | 多份修复/分析/测试报告、脚本、terraform 文档等 |

---

## 二、近期已完成（已实现并测试）

### 2.1 AI 与 Chatbot

| 功能 | 说明 |
|------|------|
| **DeepSeek 支持** | `llm_client.py` 增加 DeepSeekClient，使用 OpenAI 兼容 API |
| **API Key 设置** | 在 Web「设置」页配置 Claude/OpenAI/DeepSeek Key，存 MySQL（加密） |
| **Chatbot 行为** | 默认模型 DeepSeek；支持会话、历史；系统提示约束“基于数据回答” |
| **智能问题** | 后端 `GET /api/v1/chatbot/smart-questions` 根据仪表盘/成本数据动态生成推荐问题 |
| **AI 上下文** | 拉取最多 6 个月成本、优先 `pretax_amount`、注入优化建议缓存数据 |
| **Chatbot UI** | 最小化按钮、错误提示优化、便捷问题改为接口拉取 |

### 2.2 仪表盘与数据

| 功能 | 说明 |
|------|------|
| **仪表盘数据** | 修复轮询覆盖告警数、标签覆盖率；趋势优先使用后端 `summary.trend_pct`，修复“成本上升 4660%”类显示错误 |
| **折扣分析缓存** | 11 个折扣 API 加 `@cache_response`（1～3 小时 TTL），支持 `force_refresh` |
| **AI 智能洞察缓存** | `/ai-optimizer/suggestions`、`/ai-optimizer/predict` 缓存（30min/1h）；失败时返回友好错误而非 500 |
| **前端加载策略** | AI 洞察页先读缓存（短超时）再后台刷新；折扣页支持 `force_refresh` 与超时控制 |

### 2.3 后端与 API

| 功能 | 说明 |
|------|------|
| **API 结构** | `api/v1/` 模块化（accounts、costs、discounts、chatbot、ai、alerts、dashboards 等），`api/__init__.py` 统一注册 |
| **Chatbot 存储** | 消息 metadata 使用 `json.dumps` 写入 MySQL，避免 Invalid JSON |
| **账单与账号** | `chatbot` 支持 query 参数 `account`；`_get_user_context` 使用 `query_bill_items`、传入 account_id |
| **旧入口** | `web/backend/api.py` 已删除，由 `api/v1` + 其他 `api_*.py` 承担 |

### 2.4 部署与运维

| 功能 | 说明 |
|------|------|
| **Terraform** | `terraform/` 下 AWS 部署（东京）：VPC、EC2、ALB、ACM、Route53、安全组、user-data 拉代码并启动服务 |
| **user-data** | 修复 yum 冲突（`--skip-broken`）；增加 SSH 服务显式启动与结束前检查；`set +e` 避免脚本中途退出 |
| **文档** | AWS 部署指南、项目梳理（`docs/项目梳理.md`）、SSH 问题诊断等 |

### 2.5 测试与质量

| 项 | 说明 |
|------|------|
| **Web 全功能测试** | `scripts/comprehensive_web_test.py`，15 项全部通过（仪表盘、资源、成本、折扣、安全、设置、AI Chatbot 等） |
| **AI Chatbot 专项** | `scripts/test_ai_chatbot_chrome.py` 做 Chrome 自动化测试 |
| **测试报告** | `WEB_TEST_REPORT.md`、`CACHE_OPTIMIZATION_REPORT.md`、`PROJECT_ANALYSIS.md` 等已生成 |

---

## 三、进行中 / 未提交到 main

以下为工作区内已改但未提交或未完全收尾的部分：

### 3.1 代码变更（未提交）

- **core**：`bill_fetcher.py`、`bill_storage.py`、`database.py`、`discount_analyzer_advanced.py`、`security_compliance.py`；`models/resource.py`
- **web/backend**：`api/v1/` 下 ai、alerts、chatbot、dashboards、discounts；`api_alerts.py`、`api_dashboards.py`、`api_discounts.py`；新增 `api_service.py`
- **web/frontend**：`_pages/` 下 ai-optimizer、discounts、discount-trend-advanced、settings；`components/ai-chatbot.tsx`；`lib/api.ts`
- **基础设施**：`docker-compose.yml`、`nginx.conf`
- **terraform**：`user-data.sh`（SSH 与 set +e 等）、tfplan、SSH 相关说明文档

### 3.2 已知问题（未完全关闭）

- **AWS SSH**：新实例创建后 SSH 仍出现 “Connection closed by remote host”（密钥交换阶段），安全组与 22 端口正常；可能与 sshd 配置或实例初始化顺序有关，待进一步排查。
- **成本页 API**：Web 测试报告中成本分析页仍有 501 类 API 错误（不影响整体通过），可后续单独修。

---

## 四、2026 规划与完成度

依据 `DEVELOPMENT_PLAN_2026_CURSOR.md` 与 `STATE_OF_CLOUDLENS_2026.md`：

### 4.1 已对齐规划的能力

| 规划方向 | 当前状态 |
|----------|----------|
| **LLM Copilot / 自然语言查询** | 已实现 Chatbot + 多模型（Claude/OpenAI/DeepSeek）+ 智能问题 + 基于账单/成本的上下文 |
| **设置页配置 API Key** | 已实现在设置页配置并落库 |
| **折扣与 AI 洞察性能** | 已通过缓存与前端双策略缓解 |

### 4.2 规划中、尚未实现或仅部分实现

| 规划项 | 说明 |
|--------|------|
| **AI 成本归因分析** | 规划中的“一句话问成本为什么涨”的自动归因报告（资源数、折扣、使用量、价格拆解），设计有 CostAttributionEngine，实现程度待对照代码确认 |
| **Prophet / 深度预测** | 规划从线性回归升级到 Prophet/时间序列；当前成本预测仍以现有 CostPredictor 为主 |
| **多用户 / RBAC** | 规划中；当前无多用户与角色权限体系 |
| **ActionEngine / 一键执行优化** | 规划从“只读”到“可控”；当前仅有建议，无审批与执行闭环 |
| **AWS/GCP 生产级** | 规划 Q2 前 AWS；当前有 Terraform 部署到 AWS，云资源拉取仍以阿里云/腾讯云为主 |
| **单位经济效益** | 规划结合 Prometheus 做“单笔订单云成本”；未实现 |

---

## 五、代码内 TODO / 技术债（摘录）

以下为代码中明确标注的 TODO，便于排期：

### 5.1 后端 API / 服务

| 位置 | 内容 |
|------|------|
| `api_service.py` | 预算存储与查询、预算保存、报告历史存储与查询 |
| `api/v1/billing.py`、`api_billing.py` | 从原 api.py 迁移完整实现（多处） |
| `api/v1/reports.py`、`api_reports.py` | 从原 api.py 迁移完整实现 |
| `api/v1/tags.py`、`api_tags.py` | 实现成本计算 |
| `services/cost_service.py` | API 查询逻辑、成本分解逻辑 |

### 5.2 核心逻辑

| 位置 | 内容 |
|------|------|
| `budget_manager.py` | 集成 Prophet 等预测模型；按标签预算的标签匹配 |
| `alert_engine.py` | 集成预算模块；资源异常检测；安全合规检查；tag/service 过滤 |
| `ai_optimizer.py` | 资源使用率分析、降配建议；存储使用分析与优化 |
| `cost_allocation.py` | 实际使用量数据；集成虚拟标签 |
| `virtual_tags.py` | OR 逻辑；资源标签查询 |
| `cache/decorators.py` | 缓存删除 |
| `db_performance.py` | 根据查询模式分析缺失索引 |

### 5.3 前端

| 位置 | 内容 |
|------|------|
| `reports.tsx` | fetchRecentReports() |
| `dashboard-view.tsx` | 获取历史数据计算趋势 |

---

## 六、建议的下一步（优先级建议）

1. **提交与分支**  
   - 将当前已完成且测试过的功能整理成若干 commit 提交到 main（或 feature 分支再合并），避免长期堆积在工作区。

2. **AWS SSH**  
   - 单独排期排查：实例内 sshd 配置、cloud-init 与 sshd 启动顺序、是否需自定义 AMI 或启动后脚本。

3. **成本页 501**  
   - 根据 WEB_TEST_REPORT 中成本分析页的报错接口，定位并修复返回 501 的 API。

4. **API 迁移收尾**  
   - 按 TODO 将 `api/v1/billing`、`api/v1/reports` 等从原 api.py 的残留逻辑迁移完整，或明确废弃并统一走新接口。

5. **2026 路线图**  
   - 在“AI 归因 + 预测升级”“多用户/RBAC”“ActionEngine”中选 1～2 项作为 Q1 重点，与当前进度文档同步更新。

---

## 七、文档与脚本速查

| 文档 | 用途 |
|------|------|
| `docs/项目梳理.md` | 项目整体架构、目录、数据流 |
| `docs/开发进度梳理.md` | 本文档，开发进度与 TODO |
| `PROJECT_ANALYSIS.md` | 项目深度分析与 Web 模块说明 |
| `WEB_TEST_REPORT.md` | Web 全功能测试结果 |
| `CACHE_OPTIMIZATION_REPORT.md` | 折扣与 AI 洞察缓存优化说明 |
| `DEVELOPMENT_PLAN_2026_CURSOR.md` | 2026 产品与研发规划 |
| `docs/STATE_OF_CLOUDLENS_2026.md` | 2026 审计与战略建议 |
| `scripts/comprehensive_web_test.py` | Web 自动化测试入口 |
| `scripts/test_ai_chatbot_chrome.py` | AI Chatbot 专项测试 |

---

*本文档随开发推进可更新“近期已完成”“进行中”“TODO 完成情况”和“建议下一步”。*
