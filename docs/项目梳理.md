# CloudLens 项目梳理

> 统一视图 · 智能分析 · 安全合规 · 降本增效

---

## 一、项目定位与能力

**CloudLens** 是企业级多云资源治理与分析平台，面向 FinOps 与安全团队，提供：

| 能力 | 说明 |
|------|------|
| **统一抽象** | 通过统一数据模型管理阿里云、腾讯云（及预留 AWS） |
| **智能分析** | 闲置资源识别、成本预测（Prophet）、折扣异常洞察 |
| **安全合规** | CIS Benchmark 基线、公网暴露风险识别 |
| **双端交付** | **CLI** 命令行 + **Web** 可视化看板 |

---

## 二、技术栈总览

| 层级 | 技术 | 说明 |
|------|------|------|
| **CLI** | Python 3.9+、Click | 模块化命令，结构化日志 |
| **后端** | FastAPI、Uvicorn | REST API，限流、CORS、健康检查 |
| **前端** | Next.js 14（App Router）、React、TypeScript、Tailwind CSS | 中英双语、响应式 |
| **数据** | MySQL 8、Redis | 业务数据 + 缓存 |
| **AI** | Claude / OpenAI / DeepSeek（OpenAI 兼容） | 成本洞察、智能问答 |
| **部署** | Docker Compose、Nginx、Terraform（AWS） | 本地/生产一键启动 |

---

## 三、仓库结构（核心目录）

```
cloudlens/
├── cloudlens/              # 核心 Python 包（CLI + 业务逻辑）
│   ├── cli/                # CLI 入口与命令
│   ├── core/               # 核心引擎（云厂商、分析、账单、安全等）
│   ├── models/             # 统一数据模型
│   ├── providers/          # 云厂商实现（aliyun、tencent）
│   ├── resource_modules/   # 各资源类型分析器
│   └── utils/              # 通用工具
├── web/
│   ├── backend/            # FastAPI 后端
│   │   ├── api/v1/         # API 路由（按领域拆分）
│   │   ├── main.py         # 应用入口
│   │   └── services/       # 业务服务层
│   └── frontend/           # Next.js 前端
│       ├── app/            # App Router 页面与布局
│       ├── components/     # 可复用组件
│       ├── contexts/       # React Context（账号、语言）
│       ├── lib/            # API 客户端、工具
│       └── types/          # TS 类型
├── config/                 # 配置示例（schedules、thresholds）
├── migrations/              # MySQL 表结构、迁移脚本
├── scripts/                 # 启动、测试、部署脚本
├── terraform/               # AWS 部署（EC2、ALB、ACM 等）
├── tests/                   # 测试
└── docs/                    # 文档
```

---

## 四、CLI 架构

- **入口**：`cloudlens/cli/main.py`（Click Group，版本 2.1.0）
- **命令组**：`config`、`query`、`cache`、`analyze`、`remediate`、`bill`
- **单命令**：`dashboard`、`repl`、`scheduler`
- **命令实现**：`cloudlens/cli/commands/` 下按功能拆分（如 `analyze_cmd.py`、`query_cmd.py`）

**数据与配置**：

- 云账号与配置：`~/.cloudlens/config.json`
- 日志：`~/.cloudlens/logs/cloudlens.log`
- 可选环境：`~/.cloudlens/.env`

CLI 与 Web 共用 **cloudlens/core** 下的 Provider、分析器、账单、数据库等逻辑。

---

## 五、核心业务层（cloudlens/core）

### 5.1 云厂商抽象

- **BaseProvider**（`provider.py`）：抽象接口（list_instances、list_rds、list_vpcs、get_metric、check_permissions）
- **实现**：`providers/aliyun/`、`providers/tencent/`，将云 API 转为统一资源模型

### 5.2 统一数据模型（models/resource.py）

- **ResourceType**：ECS、RDS、OSS、SLB、EIP、VPC、K8S、Redis 等
- **ResourceStatus**：Running、Stopped、Starting 等
- **UnifiedResource**：id、name、provider、region、type、status、IP、规格、计费、标签、raw_data

所有云侧数据最终都转换为 `UnifiedResource` 或约定好的 Dict 结构，供分析和 API 使用。

### 5.3 核心模块（按领域）

| 领域 | 主要文件 | 作用 |
|------|----------|------|
| **成本与账单** | bill_fetcher.py、bill_storage.py、cost_analyzer.py、cost_predictor.py、cost_trend_analyzer.py | 拉取/存储账单、成本分析、趋势与预测 |
| **折扣分析** | discount_analyzer.py、discount_analyzer_advanced.py、discount_analyzer_db.py | 折扣与预留实例分析 |
| **安全合规** | security_compliance.py、security_scanner.py、cis_compliance.py | CIS 基线、公网暴露、IAM 审计 |
| **闲置与优化** | idle_detector.py、optimization_engine.py、ai_optimizer.py | 闲置识别、优化建议、AI 洞察 |
| **告警与预算** | alert_engine.py、alert_manager.py、budget_manager.py、budget_alert_service.py | 告警规则、预算与超支提醒 |
| **仪表盘与报告** | dashboard_manager.py、report_generator.py | 仪表盘配置、Excel/HTML/JSON 报告 |
| **缓存与性能** | cache/（manager、decorators）、multi_level_cache.py | 多级缓存、装饰器 |
| **AI** | llm_client.py（Claude/OpenAI/DeepSeek）、ai_optimizer.py | 大模型调用与成本洞察 |
| **基础设施** | database.py、context.py、settings.py、exceptions.py | 数据库工厂、运行上下文、配置、异常 |

### 5.4 资源分析器（resource_modules/）

按资源类型拆分：`ecs_analyzer`、`rds_analyzer`、`oss_analyzer`、`slb_analyzer`、`eip_analyzer`、`cdn_analyzer`、`ack_analyzer` 等，与 Provider 和统一模型配合，支撑「查询 + 分析」能力。

---

## 六、Web 后端架构（web/backend）

- **入口**：`main.py`（FastAPI 2.1.0，CORS、限流、健康检查、全局异常处理）
- **路由**：通过 `api/__init__.py` 的 `api_router` 统一挂载，所有 v1 模块以 `/api` 前缀对外

### API 模块（api/v1/）

| 模块 | 职责 |
|------|------|
| accounts | 云账号列表、同步 |
| resources | 资源列表、详情 |
| costs | 成本汇总、趋势 |
| billing | 账单相关 |
| discounts | 折扣分析（含缓存优化） |
| security | 安全扫描、CIS |
| budgets | 预算 CRUD、超支检测 |
| alerts | 告警配置与触发 |
| dashboards | 仪表盘配置与数据 |
| reports | 报告生成 |
| tags | 标签分析 |
| optimization | 优化建议 |
| cost_allocation | 成本分摊 |
| ai | AI 优化建议、成本预测 |
| chatbot | 智能问答、会话、LLM 配置、智能问题 |
| anomaly | 异常检测 |

部分能力在 `api_*.py` 中仍有实现，与 v1 并存，逐步可收敛到 v1。

### 数据与依赖

- **数据库**：通过 `cloudlens.core.database` 的 DatabaseFactory 使用 MySQL（环境变量：MYSQL_*）
- **Redis**：缓存与限流
- **配置**：环境变量 + `~/.cloudlens`（后端容器挂载 `~/.cloudlens` 以读账号与配置）

---

## 七、Web 前端架构（web/frontend）

- **框架**：Next.js 14（App Router）、React、TypeScript、Tailwind
- **根布局**：`app/layout.tsx`（LocaleProvider、AccountProvider、Toast、AIChatbot 全局挂载）

### 路由与页面

- **首页**：`app/page.tsx`
- **按功能页面**：`app/_pages/`（dashboard、cost、discounts、security、alerts、settings、ai-optimizer 等）
- **按账号路由**：`app/a/[account]/` 下挂 cost、resources、discounts、security、settings 等，便于按账号切换
- **组件**：`components/`（布局、图表、表格、AI 聊天、账号选择器、UI 基础组件等）

### 数据流

- **账号**：AccountContext 管理当前选中账号，请求带 account 参数
- **API**：`lib/api.ts` 封装 `apiGet`、`apiPost` 等，统一 Base URL（NEXT_PUBLIC_API_URL）、超时与错误处理
- **多语言**：LocaleContext + `lib/i18n.ts`

---

## 八、数据流概览

```
用户（浏览器 / CLI）
    ↓
前端 Next.js 或 CLI 命令
    ↓
HTTP API（FastAPI）或直接调用 core
    ↓
cloudlens/core（Provider、分析器、账单、安全、AI）
    ↓
MySQL（业务数据）/ Redis（缓存）/ 云厂商 API
```

- **配置与账号**：`~/.cloudlens/config.json`（CLI 与后端均可读）
- **账单与成本**：bill_fetcher → bill_storage / MySQL；cost_*、discount_* 读存储或缓存
- **AI**：LLM API Key 存 MySQL（加密），chatbot/ai 模块调用 llm_client

---

## 九、部署与运行

### 9.1 本地/开发

- **一键启动**：`./scripts/start.sh`（检测架构、拉镜像、起服务）
- **Compose 服务**：mysql、redis、backend、frontend、nginx（见 `docker-compose.yml`）
- **访问**：前端 http://localhost:3000，后端 http://localhost:8000，API 文档 /docs、/redoc

### 9.2 生产 / AWS

- **Terraform**：`terraform/` 内定义 VPC、EC2、ALB、ACM、Route53 等，user-data 安装 Docker 并拉代码、起服务
- **域名**：示例 `cloudlens.songqipeng.com`，DNS 需指向 ALB 或前端

### 9.3 数据库与迁移

- **初始化**：`migrations/init_mysql_schema.sql`、`add_chatbot_tables.sql`、`add_anomaly_table.sql` 等
- **启动时**：backend 容器内可执行上述 SQL（见 docker-compose 的 command）
- **脚本**：`scripts/init.sql` 供 MySQL 容器首次启动使用

---

## 十、关键配置与约定

| 项 | 说明 |
|----|------|
| 云账号 | `~/.cloudlens/config.json`，CLI config 与前端「设置」可配合使用 |
| AI Key | 在 Web 设置页配置，存 MySQL（llm_configs），支持 Claude/OpenAI/DeepSeek |
| 环境变量 | `.env`、`~/.cloudlens/.env`、Docker 环境变量（后者优先） |
| 日志 | CLI：`~/.cloudlens/logs/`；后端：应用日志 + 可选 Nginx 日志 |
| 代码规范 | 见项目根 `.cursorrules`（中文注释、类型标注、日志、错误处理、测试要求） |

---

## 十一、文档与脚本速查

- **快速开始**：README.md、QUICK_START.md、docs/QUICK_START*.md
- **部署**：DEPLOYMENT_GUIDE.md、terraform/ 内 README、docs/AWS_* 等
- **开发**：DEVELOPMENT_*.md、.cursorrules
- **脚本**：`scripts/start.sh`、`scripts/init-database.sh`、`scripts/*.py`（测试、校验、分析）

---

本梳理从「定位 → 技术栈 → 目录结构 → CLI → core → Web 后端 → Web 前端 → 数据流 → 部署 → 配置」串联整个项目，便于新人上手和后续迭代时快速定位模块与数据流。
