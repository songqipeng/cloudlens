# 折扣分析列表页测试清单

## 📋 测试范围

测试页面：`/a/[account]/discounts` - 折扣分析列表页

## ✅ 功能测试项

### 1. 数据加载
- [ ] 页面能正常加载
- [ ] 默认显示当前账期的数据
- [ ] 加载过程中显示进度提示
- [ ] 加载完成后显示数据表格

### 2. 汇总卡片
- [ ] **账期选择卡片**
  - [ ] 可以输入账期（YYYY-MM格式）
  - [ ] 修改账期后自动加载新数据
  - [ ] 显示当前数据对应的账期
  
- [ ] **原价卡片**
  - [ ] 显示总原价（税前）
  - [ ] 金额格式化正确（¥符号，千分位）
  
- [ ] **折后价卡片**
  - [ ] 显示总折后价（税前）
  - [ ] 金额格式化正确
  
- [ ] **节省/折扣卡片**
  - [ ] 显示总节省金额
  - [ ] 显示整体折扣（x.x折）
  - [ ] 筛选后显示筛选后的汇总数据

### 3. 表格功能
- [ ] **列显示**
  - [ ] 产品名称和代码正确显示
  - [ ] 计费方式正确显示（包年包月/按量付费）
  - [ ] 原价、折后价、节省金额正确显示
  - [ ] 折扣列显示折扣（x.x折）和实付比例
  - [ ] 未结算金额正确显示

- [ ] **排序功能**
  - [ ] 点击列头可以排序
  - [ ] 数值列排序正确（原价、折后价、节省金额等）
  - [ ] 文本列排序正确（产品名称、计费方式）
  - [ ] 排序图标正确显示（升序/降序）
  - [ ] 可以切换升序/降序

- [ ] **筛选功能**
  - [ ] "全部"按钮显示所有数据
  - [ ] "包年包月"按钮只显示Subscription类型
  - [ ] "按量付费"按钮只显示PayAsYouGo类型
  - [ ] 筛选后表格数据正确更新
  - [ ] 筛选后汇总卡片显示筛选后的数据

- [ ] **搜索功能**
  - [ ] 可以输入产品代码搜索
  - [ ] 可以输入产品名称搜索
  - [ ] 搜索不区分大小写
  - [ ] 搜索后表格正确过滤
  - [ ] 清空搜索后恢复显示

### 4. 数据准确性
- [ ] **折扣计算**
  - [ ] 折扣金额 = 原价 - 折后价（验证计算正确）
  - [ ] 实付比例 = 折后价 / 原价（验证计算正确）
  - [ ] 折扣（折） = 实付比例 × 10（验证计算正确）
  - [ ] 免费项目正确显示为"免费"

- [ ] **数据验证**
  - [ ] 折后价不超过原价（如有异常应高亮显示）
  - [ ] 折扣金额不超过原价
  - [ ] 数据格式正确（数字、null处理等）

- [ ] **汇总统计**
  - [ ] 汇总卡片数据与表格数据一致
  - [ ] 筛选后汇总数据正确计算
  - [ ] 整体折扣率计算正确

### 5. 边界情况
- [ ] **空数据**
  - [ ] 无数据时显示友好提示
  - [ ] 提示信息清晰

- [ ] **免费项目**
  - [ ] 原价>0但折后价=0的项目显示为"免费"
  - [ ] 折扣列正确显示"免费"

- [ ] **异常数据**
  - [ ] null值正确处理（显示"-"）
  - [ ] 0值正确显示
  - [ ] 负数正确处理

### 6. 交互功能
- [ ] **加载缓存按钮**
  - [ ] 点击后从缓存加载数据
  - [ ] 缓存数据正确显示

- [ ] **强制刷新按钮**
  - [ ] 点击后重新从API获取数据
  - [ ] 刷新过程中显示进度
  - [ ] 刷新完成后更新数据

- [ ] **取消请求按钮**
  - [ ] 加载过程中可以取消
  - [ ] 取消后状态正确恢复

### 7. 错误处理
- [ ] **超时处理**
  - [ ] 请求超时显示友好提示
  - [ ] 提示信息包含等待时间
  - [ ] 可以重试或使用缓存

- [ ] **API错误**
  - [ ] API错误时显示错误信息
  - [ ] 错误信息清晰易懂

### 8. UI/UX
- [ ] **响应式布局**
  - [ ] 在不同屏幕尺寸下正常显示
  - [ ] 表格可以横向滚动（如需要）

- [ ] **视觉反馈**
  - [ ] 加载状态清晰
  - [ ] 排序状态清晰（图标显示）
  - [ ] 筛选状态清晰（按钮高亮）
  - [ ] hover效果正常

- [ ] **数据格式化**
  - [ ] 金额使用等宽字体
  - [ ] 金额格式化正确（¥符号，千分位）
  - [ ] 折扣格式化正确（x.x折）

## 🔍 数据准确性验证公式

### 行级验证
```
折扣金额 = max(0, 原价 - 折后价)
实付比例 = 折后价 / 原价 (如果原价 > 0)
折扣（折） = 实付比例 × 10 (如果实付比例存在且折后价 > 0)
免费 = 原价 > 0 且 折后价 = 0
```

### 汇总验证
```
总原价 = Σ(所有行的原价)
总折后价 = Σ(所有行的折后价)
总折扣金额 = Σ(所有行的折扣金额)
整体实付比例 = 总折后价 / 总原价 (如果总原价 > 0)
整体折扣（折） = 整体实付比例 × 10 (如果整体实付比例存在且总折后价 > 0)
```

## 🐛 已知问题和修复

### 已修复的问题
1. ✅ **排序功能缺失** - 已实现完整的排序功能
2. ✅ **数据验证缺失** - 已添加数据准确性验证
3. ✅ **空数据提示** - 已添加友好的空状态提示
4. ✅ **筛选后统计** - 已添加筛选后的汇总数据计算
5. ✅ **边界情况处理** - 已优化0折、免费等情况

### 待验证的问题
- [ ] 实际数据加载是否正常
- [ ] 后端API返回的数据格式是否正确
- [ ] 大数据量下的性能表现

## 📝 测试步骤

1. **访问页面**
   ```
   打开浏览器，访问：http://localhost:3000/a/[账号名]/discounts
   ```

2. **测试数据加载**
   - 观察页面是否正常加载
   - 检查汇总卡片数据是否正确
   - 检查表格数据是否正确

3. **测试排序**
   - 点击各列头测试排序
   - 验证排序结果是否正确
   - 验证排序图标是否正确显示

4. **测试筛选**
   - 点击"全部"、"包年包月"、"按量付费"按钮
   - 验证表格数据是否正确过滤
   - 验证汇总卡片是否更新

5. **测试搜索**
   - 输入产品代码搜索
   - 输入产品名称搜索
   - 验证搜索结果是否正确

6. **测试数据准确性**
   - 随机选择几行数据
   - 手动计算折扣金额、实付比例
   - 验证与显示数据是否一致

7. **测试边界情况**
   - 切换到无数据的账期
   - 测试免费项目显示
   - 测试null值处理

8. **测试错误处理**
   - 断开网络测试超时
   - 测试API错误情况

## ✅ 测试完成标准

- [ ] 所有功能测试项通过
- [ ] 数据准确性验证通过
- [ ] 边界情况处理正确
- [ ] 错误处理友好
- [ ] UI/UX符合设计规范

---

**测试日期**: 2026-01-18  
**测试状态**: 待测试  
**代码状态**: ✅ 已优化
