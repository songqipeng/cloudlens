# CloudLens 折扣趋势分析指南

> **版本**: v2.1.0  
> **功能**: 基于阿里云账单CSV，分析最近6个月折扣变化趋势  
> **更新日期**: 2025-12

---

## 📋 功能概述

CloudLens 折扣趋势分析功能可以帮助您：

✅ **追踪折扣变化** - 分析最近6个月的折扣率变化趋势  
✅ **多维度分析** - 支持按产品、合同、实例维度分析  
✅ **商务决策支持** - 识别折扣下降的产品，及时与商务沟通  
✅ **成本优化** - 找出折扣最高的资源，优化采购策略  

---

## 🚀 快速开始

### 1. 准备账单数据

#### 步骤1: 从阿里云控制台下载账单

1. 登录 [阿里云控制台](https://usercenter2.aliyun.com/)
2. 进入 **费用中心 → 账单管理 → 账单详情**
3. 选择账期（建议下载最近6个月）
4. 点击 **导出账单明细（CSV）**
5. 下载完成后解压文件

#### 步骤2: 组织账单文件

将账单CSV文件放在以账号ID命名的目录中：

```
aliyunidle/
└── 1844634015852583-账号名称/
    ├── 1844634015852583-账号-202507-res_consume_detail_1.csv
    ├── 1844634015852583-账号-202508-res_consume_detail_1.csv
    ├── 1844634015852583-账号-202509-res_consume_detail_1.csv
    └── ...
```

**提示**: 账单文件可以分多个文件（如 detail_1.csv, detail_2.csv...），分析器会自动合并。

---

### 2. 运行分析

#### 基础用法

```bash
# 自动查找项目根目录下的账单目录
./cl analyze discount

# 指定账单目录
./cl analyze discount --bill-dir ./1844634015852583-ydzn

# 分析最近12个月
./cl analyze discount --months 12
```

#### 导出报告

```bash
# 导出HTML报告（默认）
./cl analyze discount --export

# 导出Excel报告
./cl analyze discount --export --format excel

# 导出JSON数据
./cl analyze discount --export --format json
```

---

## 📊 分析维度

### 1. 总体趋势

- **最新折扣率** - 最近一个月的平均折扣率
- **平均折扣率** - 分析周期内的平均折扣率
- **折扣率变化** - 相比首月的变化百分比
- **趋势方向** - 上升/下降/平稳
- **累计节省** - 总折扣金额

### 2. 产品维度

按产品聚合折扣数据：

- 各产品的累计折扣金额
- 平均折扣率
- 折扣率变化趋势
- TOP 20 折扣产品

**示例输出**:
```
产品                    累计折扣        平均折扣率    趋势
云消息队列 Kafka 版      ¥150,234.56    52.3%        📈 上升
云数据库 RDS            ¥89,123.45     48.7%        ➡️ 平稳
云服务器 ECS            ¥67,890.12     35.2%        📉 下降
```

### 3. 合同维度

按商务合同聚合：

- 合同编号与优惠名称
- 累计折扣金额
- 平均折扣率
- 覆盖月份数

**应用场景**: 评估商务合同的实际折扣效果，为续签谈判提供数据支持。

### 4. 实例维度

分析单个实例的折扣情况：

- TOP 50 折扣最高的实例
- 实例级折扣率
- 官网价 vs 实付价对比

**应用场景**: 识别高价值资源，优化续费和采购策略。

---

## 🎯 典型应用场景

### 场景1: 商务合同续签评估

**需求**: 年度商务合同即将到期，需要评估当前折扣水平，为续签谈判准备数据。

**操作步骤**:

```bash
# 1. 分析最近6个月折扣趋势
./cl analyze discount --export

# 2. 查看报告（自动打开HTML）
# 关注以下指标：
#   - 平均折扣率是否达到预期
#   - 哪些产品折扣率最高/最低
#   - 折扣率是否有下降趋势
```

**决策依据**:
- 如果折扣率下降 > 5%，需要与商务沟通原因
- 识别折扣率低的产品，作为续签谈判重点
- 对比不同合同的折扣效果

---

### 场景2: 成本优化机会识别

**需求**: 识别折扣率较低的资源，优化采购策略。

**操作步骤**:

```bash
# 分析折扣趋势
./cl analyze discount --export --format excel
```

**分析要点**:
1. 查看 **产品折扣分析** sheet
   - 找出折扣率 < 30% 的产品
   - 评估是否有更优惠的采购方式
2. 查看 **TOP50实例折扣** sheet
   - 对比高折扣和低折扣实例
   - 调整资源配置策略

**优化建议**:
- 折扣率低的产品考虑切换为预留实例
- 批量续费可获得更高折扣
- 与商务沟通提高折扣比例

---

### 场景3: 月度折扣监控

**需求**: 每月跟踪折扣变化，及时发现异常。

**操作步骤**:

```bash
# 设置定时任务（每月1号执行）
# crontab -e
0 9 1 * * cd /path/to/aliyunidle && ./cl analyze discount --export
```

**监控指标**:
- 折扣率是否有异常下降（> 5%）
- 是否有新的折扣合同生效
- 哪些产品折扣率变化最大

---

## 📖 数据字段说明

### 账单CSV必需字段

分析器会读取以下关键字段：

| 字段名 | 说明 | 用途 |
|--------|------|------|
| 账期 | 账单月份（yyyy-MM） | 时间维度聚合 |
| 产品Code | 产品代码 | 产品维度分析 |
| 产品 | 产品名称 | 显示用 |
| 实例ID | 资源实例ID | 实例维度分析 |
| 官网价 | 税前官网价 | 计算折扣率基准 |
| 优惠金额 | 折扣金额 | 节省金额 |
| 应付金额 | 实际应付（折后） | 实际成本 |
| 优惠名称 | 优惠活动名称 | 识别折扣来源 |
| 合同编号 | 商务合同编号 | 合同维度分析 |
| 优惠类型 | 折扣/资源包等 | 折扣类型分类 |

### 折扣率计算公式

```
折扣率 = 优惠金额 / 官网价
折扣率(%) = 折扣率 × 100

示例：
  官网价: ¥1000
  优惠金额: ¥500
  应付金额: ¥500
  折扣率: 50%（5折）
```

---

## 🔧 高级功能

### 与BSS API折扣对比

CloudLens 提供两种折扣分析方式：

#### 1. **CSV 离线分析** (推荐用于长期趋势)

- 命令: `./cl analyze discount`
- 优点: 
  - 支持历史6个月趋势分析
  - 可离线分析，不依赖API权限
  - 包含完整的明细数据
- 缺点:
  - 需要手动下载CSV文件
  - 数据有延迟（通常1-2天）

#### 2. **BSS API 实时查询** (推荐用于当前月)

- API: `GET /api/billing/discounts`
- 优点:
  - 实时数据
  - 自动化，无需手动下载
- 缺点:
  - 需要BSS API权限
  - 只能查询单月数据
  - 历史趋势分析困难

**最佳实践**: 两者结合使用
- 使用CSV分析查看长期趋势
- 使用API实时监控当前月

---

## 🌐 Web界面使用

### 访问折扣分析页面

```
http://localhost:3000/discounts
```

### 功能特性

1. **折扣率趋势图表**
   - 交互式时间序列图
   - 可缩放、查看详情

2. **产品折扣对比**
   - 按产品查看折扣率
   - 柱状图/饼图可视化

3. **TOP折扣实例**
   - 折扣金额最高的50个实例
   - 可导出Excel

4. **合同效果分析**
   - 各商务合同的折扣效果
   - 帮助评估合同价值

---

## 📈 报告示例

### HTML报告包含

1. **核心指标卡片**
   - 最新折扣率、平均折扣率
   - 折扣率变化、趋势方向
   - 累计节省金额

2. **折扣率趋势图**
   - 6个月折扣率变化曲线
   - 平均值参考线

3. **折扣金额趋势图**
   - 官网价 vs 折扣金额对比
   - 双柱状图展示

4. **产品折扣表格**
   - TOP 20产品折扣明细
   - 趋势指示器

5. **合同折扣表格**
   - TOP 10商务合同效果

6. **TOP 50实例折扣**
   - 折扣金额最高的实例
   - 用于重点关注

---

## ❓ 常见问题

### Q1: 如何下载多个月的账单？

**答**: 
1. 在阿里云控制台账单详情页
2. 切换账期（2025-07、2025-08...）
3. 分别下载每个月的CSV
4. 将所有CSV文件放在同一个目录

### Q2: 账单文件很大（100万+行），分析会很慢吗？

**答**:
- 首次分析需要解析CSV（约1-2分钟）
- 分析结果会缓存24小时
- 后续查询直接使用缓存（秒级响应）
- 建议定期更新缓存（每周或每月）

### Q3: 折扣率计算是否准确？

**答**:
- 折扣率 = 优惠金额 / 官网价
- 数据来源：阿里云官方账单CSV
- 与控制台显示的折扣率一致
- 注意：资源包抵扣不计入优惠金额

### Q4: 可以分析AWS、腾讯云的账单吗？

**答**:
- 当前版本仅支持阿里云账单CSV
- AWS、腾讯云账单格式不同，需要单独适配
- 计划在 v2.2 版本支持

### Q5: 分析报告可以分享给团队吗？

**答**:
- HTML报告可以直接打开分享
- Excel报告可用于深度分析
- JSON数据可集成到其他系统

---

## 🎓 最佳实践

### 1. 定期监控

**建议频率**: 每月1号

```bash
#!/bin/bash
# 自动化脚本 - monthly_discount_check.sh

# 下载最新账单（需要手动或通过API自动化）
# ...

# 运行折扣分析
cd /path/to/aliyunidle
./cl analyze discount --export

# 发送报告（邮件/钉钉/企业微信）
# ...
```

### 2. 折扣下降预警

**阈值设置**: 折扣率下降 > 5%

**处理流程**:
1. 识别折扣下降的产品
2. 检查是否合同到期
3. 与商务沟通续签事宜
4. 评估切换采购方式

### 3. 成本优化决策

**决策矩阵**:

| 折扣率 | 采购建议 |
|--------|----------|
| > 50% | 优先采购，锁定长期合同 |
| 30-50% | 正常采购 |
| < 30% | 评估替代方案，与商务沟通提高折扣 |

### 4. 合同效果评估

**评估指标**:
- 合同覆盖的产品范围
- 平均折扣率是否达到承诺值
- 折扣稳定性（是否波动）

---

## 🔗 与其他功能集成

### 与成本分析结合

```bash
# 1. 成本趋势分析
./cl analyze cost --account prod --trend

# 2. 折扣趋势分析
./cl analyze discount --export

# 3. 综合评估
#    - 成本是否增长？
#    - 折扣率是否下降？
#    - 是否需要优化采购策略？
```

### 与闲置分析结合

```bash
# 1. 识别闲置资源
./cl analyze idle --account prod

# 2. 查看闲置资源的折扣情况
./cl analyze discount --export --format excel
# 在Excel中筛选闲置实例ID

# 3. 决策
#    - 高折扣+闲置：释放浪费更大
#    - 低折扣+闲置：优先释放
```

---

## 📚 API文档

### Web API端点

#### 1. 获取折扣趋势

```
GET /api/discounts/trend?months=6&force_refresh=false
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "account_name": "1844634015852583",
    "analysis_periods": ["2025-12", "2025-11", ...],
    "trend_analysis": {
      "latest_discount_rate": 0.5743,
      "average_discount_rate": 0.5268,
      "trend_direction": "上升",
      "total_savings_6m": 2579330.06
    },
    "product_analysis": {...},
    "contract_analysis": {...}
  }
}
```

#### 2. 获取产品折扣详情

```
GET /api/discounts/products?product=kafka
```

**用途**: 查询特定产品的折扣明细。

---

## 🛠️ 故障排查

### 问题1: 未找到账单目录

**错误信息**: `未找到账单CSV目录`

**解决方案**:
1. 确认账单CSV文件已下载并解压
2. 将文件放在以账号ID命名的目录
3. 或使用 `--bill-dir` 参数明确指定

### 问题2: 解析失败

**错误信息**: `Failed to parse CSV`

**解决方案**:
1. 确认CSV文件编码为UTF-8
2. 确认CSV文件格式正确（76个字段）
3. 检查CSV文件是否损坏

### 问题3: 缓存数据过期

**解决方案**:
```bash
# 强制刷新缓存
./cl analyze discount --export
# 或清理缓存
rm -rf ~/.cloudlens/discount_cache
```

---

## 📊 数据口径说明

### 折扣金额计算

```
官网价 = 单价 × 用量（未折扣）
优惠金额 = 官网价 - 应付金额
应付金额 = 官网价 - 优惠金额（折后）
```

### 不同优惠类型

1. **合同优惠** - 商务合同折扣（如：整单5.0折）
2. **单品优惠** - 产品级折扣
3. **组合优惠** - 组合购买折扣
4. **资源包抵扣** - 不计入优惠金额
5. **代金券抵扣** - 计入优惠金额

---

## 🎯 路线图

### 已实现 (v2.1)
- ✅ CSV账单解析
- ✅ 6个月折扣趋势分析
- ✅ 产品/合同/实例维度分析
- ✅ HTML/Excel/JSON报告导出
- ✅ CLI命令
- ✅ Web API

### 计划中 (v2.2)
- ⏳ 账单自动下载（BSS API）
- ⏳ 折扣率预警（邮件/钉钉通知）
- ⏳ 折扣优化建议（AI推荐）
- ⏳ 多账号折扣对比
- ⏳ AWS、腾讯云账单支持

---

## 🆘 获取帮助

- **查看命令帮助**: `./cl analyze discount --help`
- **GitHub Issues**: 提交Bug或功能请求
- **文档**: [完整用户指南](../USER_GUIDE.md)

---

**最后更新**: 2025-12-15


