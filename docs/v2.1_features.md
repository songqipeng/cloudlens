# v2.1新功能详细指南

本文档详细介绍CloudLens v2.1版本的新功能和增强特性。

---

## 1. 成本趋势分析

### 功能说明
自动记录成本快照,分析历史趋势,支持环比/同比分析。

### 使用方法

```bash
# 记录当前成本快照
python3 cl_new.py analyze cost --account prod

# 查看趋势分析
python3 cl_new.py analyze cost --account prod --trend --days 30
```

### 输出示例

```
📊 当前成本概览
━━━━━━━━━━━━━━━━━━
账号: prod
总资源数: 45
预估月成本: ¥12,850.00

按资源类型分布:
┌─────────┬──────────┬───────┐
│资源类型   │月成本     │占比    │
├─────────┼──────────┼───────┤
│ECS      │¥8,500.00 │66.1% │
│RDS      │¥3,200.00 │24.9% │
│Redis    │¥1,150.00 │8.9%  │
└─────────┴──────────┴───────┘

📈 成本趋势分析 (最近30天)
━━━━━━━━━━━━━━━━━━
分析周期: 30 天
最新成本: ¥12,850.00
平均成本: ¥12,200.00
总变化: +650.00 (+5.3%)
环比(MoM): +320.00 (+2.6%)
```

### 数据存储
- 位置: `data/cost/cost_history.json`
- 格式: JSON
- 保留: 365天历史数据

---

## 2. AI成本预测

### 功能说明
使用机器学习模型预测未来成本趋势,支持Prophet和简单线性模型。

### 安装依赖

```bash
# 推荐: 安装Prophet获得更准确预测
pip install prophet

# 备选: 不安装会自动降级到简单线性模型
```

### 使用方法

```bash
# 预测未来90天成本
python3 cl_new.py analyze forecast --account prod --days 90

# 预测30天
python3 cl_new.py analyze forecast --account prod --days 30
```

### 输出示例

```
🔮 AI成本预测 (未来90天)

📈 PROPHET模型预测结果
━━━━━━━━━━━━━━━━━━━
账号: prod
预测周期: 90 days
预测总成本: ¥38,500.00
日均成本: ¥427.78
增长率: +8.5%

✓ 成本增长在可控范围内
```

### 注意事项
- 需要至少30天历史数据
- Prophet模型准确度通常在85%+
- 建议设置定时任务每天记录成本

---

## 3. CIS Benchmark合规检查

### 功能说明
基于CIS (Center for Internet Security) 安全基准进行合规检查,覆盖10+检查项。

### 检查项分类
1. **IAM (身份管理)**: MFA启用、Root密钥检查
2. **Network (网络安全)**: 安全组规则、VPC流日志、公网暴露
3. **Data (数据安全)**: 磁盘加密、RDS备份、OSS日志
4. **Audit (审计监控)**: ActionTrail、日志服务

### 使用方法

```bash
# 基础安全检查
python3 cl_new.py analyze security --account prod

# CIS Benchmark完整检查
python3 cl_new.py analyze security --account prod --cis
```

### 输出示例

```
🛡️ CIS Benchmark合规检查

CIS合规评分
━━━━━━━━━━━━━━
合规分数: 75%
通过: 7 | 失败: 3

分类汇总:
┌────────┬─────────┬──────────┐
│类别     │合规率    │通过/总数  │
├────────┼─────────┼──────────┤
│IAM     │50.0%   │1/2      │
│Network │66.7%   │2/3      │
│Data    │100.0%  │3/3      │
│Audit   │50.0%   │1/2      │
└────────┴─────────┴──────────┘

❌ 未通过的检查项 (3个):
✗ [1.1] 确保MFA已启用 [HIGH]
  └─ MFA检查需要RAM API支持
✗ [2.2] VPC流日志已启用 [MEDIUM]
  └─ VPC流日志检查需要VPC API支持
✗ [4.2] 日志服务已配置 [MEDIUM]
  └─ 日志服务检查需要SLS API支持
```

### 合规建议
- 目标合规率: 80%+
- 定期检查: 每周一次
- 关注高危项: CRITICAL和HIGH级别

---

## 4. 自动修复引擎

### 功能说明
批量修复资源问题,支持干运行模式和完整审计日志。

### 安全特性
- ✅ 默认强制干运行
- ✅ 需要`--confirm`才实际执行
- ✅ 完整审计日志记录
- ✅ 支持回滚查看

### 标签自动修复

```bash
# 干运行预览(默认)
python3 cl_new.py remediate tags --account prod

# 指定标签
python3 cl_new.py remediate tags \
  --account prod \
  --env production \
  --owner devops

# 确认执行
python3 cl_new.py remediate tags --account prod --confirm
```

**输出示例(干运行)**:
```
🏷️ 自动打标签 (干运行模式)

预览结果
━━━━━━━━━━━━━━
总资源数: 45
需要打标签: 12

将添加标签的资源 (前10个):
┌─────────────┬───────────┬──────────────────────┐
│资源ID        │资源类型    │标签                   │
├─────────────┼───────────┼──────────────────────┤
│i-xxx1       │ECS        │env=production, ...   │
│i-xxx2       │ECS        │env=production, ...   │
└─────────────┴───────────┴──────────────────────┘

⚠️ 这是干运行模式,未实际执行修改
要实际执行,请添加 --confirm 标志
```

### 查看修复历史

```bash
# 查看最近20条
python3 cl_new.py remediate history

# 查看最近50条
python3 cl_new.py remediate history --limit 50
```

**输出示例**:
```
📜 自动修复历史

┌────────────────────┬──────────┬─────────────┬────────┐
│时间                 │操作       │资源ID        │状态     │
├────────────────────┼──────────┼─────────────┼────────┤
│2025-12-09 16:20   │add_tags  │i-xxx1       │✓ success│
│2025-12-09 16:20   │add_tags  │i-xxx2       │✓ success│
└────────────────────┴──────────┴─────────────┴────────┘
```

### 审计日志
- 位置: `data/remediation/audit.log`
- 格式: JSON Lines (每行一个JSON对象)
- 内容: 时间戳、操作、资源ID、详情、状态

---

## 5. 性能优化

### 异步I/O架构(准备中)
v2.1引入了AsyncProvider基础架构,为未来的高性能异步查询做准备。

```python
# 架构示例(开发中)
async with AsyncAliyunProvider(...) as provider:
    instances = await provider.list_instances()  # 非阻塞
```

**预期性能提升**: 5-10倍

---

## 6. 最佳实践

### 成本优化流程
```bash
# 1. 记录基线成本
cl analyze cost --account prod

# 2. 分析闲置资源
cl analyze idle --account prod

# 3. 查看成本趋势
cl analyze cost --account prod --trend --days 30

# 4. AI预测未来成本
cl analyze forecast --account prod --days 90

# 5. 执行优化(如有)
cl remediate tags --account prod --confirm
```

### 安全合规流程
```bash
# 1. 基础安全检查
cl analyze security --account prod

# 2. CIS合规检查
cl analyze security --account prod --cis

# 3. 修复问题(手动)

# 4. 重新检查
cl analyze security --account prod --cis
```

### 定时任务配置

```bash
# crontab示例
# 每天凌晨2点记录成本
0 2 * * * cd /path/to/aliyunidle && python3 cl_new.py analyze cost --account prod >> /var/log/cloudlens-cost.log 2>&1

# 每周一早上8点CIS检查
0 8 * * 1 cd /path/to/aliyunidle && python3 cl_new.py analyze security --account prod --cis >> /var/log/cloudlens-security.log 2>&1
```

---

## 7. 常见问题

### Q: AI预测提示"需要历史数据"?
A: 至少需要30天历史数据。多次运行`cl analyze cost`积累数据,建议设置每天定时任务。

### Q: CIS检查很多项显示"需要API支持"?
A: 部分检查项需要云厂商API支持,当前版本已实现核心检查项,未来会逐步完善。

### Q: 自动修复会不会误操作?
A: 默认强制干运行模式,必须添加`--confirm`才实际执行,且有完整审计日志。

### Q: Prophet安装失败怎么办?
A: Prophet依赖较多,可以不安装。工具会自动降级到简单线性模型,准确度略低但仍可用。

### Q: 如何导出CIS合规报告?
A: 当前支持终端输出,未来版本会支持PDF/Excel导出。

---

## 8. 更新日志

### v2.1.0 (2025-12-09)
- ✨ 新增: 成本趋势分析
- ✨ 新增: AI成本预测(Prophet ML)
- ✨ 新增: CIS Benchmark合规检查
- ✨ 新增: 自动修复引擎
- ✨ 新增: 异步I/O架构基础
- 🐛 修复: CacheManager API不一致
- 🐛 修复: IdleDetector阈值逻辑
- 📝 文档: 完善用户手册

### v2.0.0 (2024-11-15)
- ✨ 交互式REPL
- ✨ TUI仪表盘
- ✨ 高级查询引擎
- ✨ 智能缓存系统

---

## 9. 技术支持

- GitHub Issues: <repository>/issues
- 文档: README.md, TECHNICAL_ARCHITECTURE.md
- 示例: examples/目录

---

**CloudLens - 让多云治理更简单!** 🚀
