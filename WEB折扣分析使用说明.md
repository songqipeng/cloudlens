# CloudLens Web 折扣分析功能使用说明

## 🚀 快速开始（3步）

### 1️⃣ 启动服务

**选择一种方式：**

**方式A: 一键启动（推荐）**
```bash
./start_web.sh
```

**方式B: 手动启动**
```bash
# 终端1: 启动后端
cd web/backend
python3 run.py

# 终端2: 启动前端
cd web/frontend
npm run dev
```

等待服务启动（约10秒）

### 2️⃣ 访问页面

打开浏览器访问：
```
http://localhost:3000/discounts
```

如果端口3000被占用，Next.js会自动使用3001或3002端口。

### 3️⃣ 查看折扣分析

页面会自动加载缓存数据（<1秒），显示：
- 📊 核心指标（4个卡片）
- 📈 折扣率趋势图
- 📦 产品分析表格
- 📄 合同分析
- 🏆 TOP实例排名

---

## 📊 页面功能说明

### 核心指标卡片

```
┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│ 最新折扣率     │  │ 平均折扣率     │  │ 折扣趋势       │  │ 累计节省       │
│ 57.43%         │  │ 52.68%         │  │ 上升           │  │ ¥258万         │
│ 📈 +6.85% ↑    │  │ 最近6个月      │  │ 50%-57%        │  │ 最近6个月      │
└────────────────┘  └────────────────┘  └────────────────┘  └────────────────┘
```

### Tab 1: 趋势总览

**折扣率趋势图**（折线图）
- 展示6个月折扣率变化曲线
- 鼠标悬停显示具体数值
- 平滑曲线，紫色主题

**折扣金额对比图**（柱状图+折线图）
- 蓝色柱：官网价
- 绿色柱：折扣金额
- 橙色线：应付金额

### Tab 2: 产品分析

**TOP 20 产品折扣表格**

| 产品 | 累计折扣 | 平均折扣率 | 最新折扣率 | 变化 | 趋势 |
|------|---------|-----------|-----------|------|------|
| 云服务器 ECS | ¥141万 | 57.69% | 57.43% | +1.23% | 📈 上升 |
| ... | ... | ... | ... | ... | ... |

**功能**:
- 点击列标题排序
- 趋势图标（📈上升、📉下降、➡️平稳）

### Tab 3: 合同分析

**TOP 10 商务合同卡片**

```
┌──────────────────────────────────────────────────────┐
│ #1 合同优惠_整单_5.0折                    ¥123万     │
│ 合同编号: ALY20250616174046069782_V1                │
├──────────────────────────────────────────────────────┤
│ 平均折扣率: 51.19%  |  最新: 52.34%  |  覆盖: 6个月 │
└──────────────────────────────────────────────────────┘
```

### Tab 4: TOP实例

**TOP 50 高折扣实例表格**

| 实例ID | 实例名称 | 产品 | 官网价 | 折扣金额 | 折扣率 | 应付金额 |
|--------|---------|------|--------|---------|--------|---------|
| i-xxx | prod-web-01 | ECS | ¥1,000 | ¥500 | `50%` | ¥500 |

**Badge颜色**:
- 🟢 ≥50%: 绿色（优秀折扣）
- 🟡 30-50%: 黄色（正常折扣）
- 🔴 <30%: 红色（需关注）

---

## 🔄 数据更新

### 自动缓存（24小时）

首次访问或强制刷新后，数据会缓存24小时：
- 快速响应：<1秒
- 减少服务器压力
- 提升用户体验

### 强制刷新

点击页面右上角"强制刷新"按钮：
- 重新解析CSV文件（60-90秒）
- 获取最新折扣数据
- 刷新所有图表和表格

### 更新账单数据

定期（每月）下载新的账单CSV：
1. 下载最新账期的CSV
2. 放入账单目录
3. 在Web页面点击"强制刷新"

---

## 💡 使用技巧

### 技巧1: 快速评估折扣水平

看"平均折扣率"卡片：
- ≥50%: 优秀水平 ✅
- 40-50%: 正常水平 🟡
- <40%: 需要优化 🔴

### 技巧2: 识别折扣下降风险

查看"折扣率变化"：
- 下降 > 5%: ⚠️ 立即关注
- 下降 2-5%: 🟡 需要注意
- 下降 < 2%: ✅ 正常波动

### 技巧3: 找到优化机会

切换到"产品分析"Tab：
1. 按"平均折扣率"列排序（升序）
2. 找出折扣率最低的产品
3. 评估是否有优化空间
4. 与商务沟通提高折扣

### 技巧4: 商务谈判准备

切换到"合同分析"Tab：
1. 查看各合同的累计节省
2. 评估平均折扣率是否达标
3. 对比不同合同效果
4. 准备续签谈判材料

---

## 🎯 典型工作流

### 月度折扣审查会议

**时间**: 每月第一个工作日

**流程**:
1. **准备数据**（前一天）
   - 下载上月账单CSV
   - 放入账单目录

2. **生成报告**（会议前）
   ```bash
   # CLI导出Excel
   ./cl analyze discount --export --format excel
   ```

3. **会议展示**（使用Web页面）
   - 访问 /discounts 页面
   - 展示核心指标卡片
   - 切换Tab展示各维度分析
   - 截图关键数据

4. **输出行动项**
   - 折扣率下降的产品 → 商务沟通
   - 低折扣产品 → 优化采购方式
   - 合同到期 → 续签准备

---

## 🛠️ 故障排查

### 问题1: 页面显示"加载失败"

**排查步骤**:
```bash
# 1. 检查后端是否运行
curl http://127.0.0.1:8000/health
# 应返回: {"status":"ok"}

# 2. 测试API是否正常
curl "http://127.0.0.1:8000/api/discounts/trend?months=6"

# 3. 检查账单目录
ls -la 1844634015852583-*/

# 4. 查看后端日志
tail -50 logs/backend_live.log
```

### 问题2: Next.js 端口冲突

**症状**: "Port 3000 is in use"

**解决方案**:
```bash
# 方案1: 使用新端口访问
# Next.js会自动使用3001或3002
http://localhost:3001/discounts

# 方案2: 停止旧进程
pkill -f "next dev"
# 重新启动
cd web/frontend && npm run dev
```

### 问题3: 图表不显示

**排查步骤**:
```bash
# 1. 检查recharts是否安装
cd web/frontend
npm list recharts

# 2. 检查浏览器控制台
# 打开浏览器开发者工具（F12）
# 查看Console是否有JavaScript错误

# 3. 清理缓存重试
rm -rf .next
npm run dev
```

### 问题4: 数据为空

**排查步骤**:
```bash
# 1. 测试CLI命令
./cl analyze discount

# 2. 检查缓存
ls -la ~/.cloudlens/discount_cache/

# 3. 清理缓存重试
rm -rf ~/.cloudlens/discount_cache/
# 在Web点击"强制刷新"
```

---

## 📱 移动端使用

Web页面完全响应式，支持移动设备：

**手机访问**:
1. 在同一网络下，使用电脑IP访问
   ```
   http://192.168.x.x:3000/discounts
   ```

2. 或使用端口转发（ngrok等工具）

**移动端优化**:
- 单列卡片布局
- 触控友好的Tab切换
- 表格横向滚动
- 图表自适应缩放

---

## 🔗 相关功能链接

### Web导航

- **Dashboard**: http://localhost:3000 - 总览
- **成本分析**: http://localhost:3000/cost - 成本趋势
- **折扣分析**: http://localhost:3000/discounts - 折扣趋势 ✨
- **资源管理**: http://localhost:3000/resources - 资源列表
- **安全合规**: http://localhost:3000/security - 安全检查

### CLI命令

```bash
# 折扣分析
./cl analyze discount

# 成本分析
./cl analyze cost --trend

# 闲置分析
./cl analyze idle
```

---

## 📈 预期效果（真实数据）

基于账单 `1844634015852583-ydzn`（143万行，6个月）：

```
【核心指标】
├─ 累计节省: ¥2,579,330.06
├─ 平均折扣率: 52.68%
├─ 最新折扣率: 57.43%
├─ 折扣趋势: 📈 上升 +6.85%
└─ 分析周期: 2025-07 至 2025-12

【TOP产品】
├─ 云服务器 ECS: ¥1,416,697.74（57.69%）
├─ 云数据库 RDS: ¥247,634.16（56.40%）
└─ 支持计划: ¥150,000.00（100%）

【TOP合同】
└─ ALY20250616174046069782_V1
   ├─ 优惠名称: 合同优惠_整单_5.0折
   ├─ 累计节省: ¥1,235,857.82
   └─ 平均折扣率: 51.19%
```

---

## 🎓 最佳实践

### 1. 定期查看（月度）

**建议频率**: 每月1号

**检查项**:
- [ ] 最新折扣率是否正常
- [ ] 折扣率是否有异常下降
- [ ] 有无新合同生效
- [ ] 哪些产品折扣变化最大

### 2. 商务沟通（季度）

**准备材料**:
- 折扣趋势截图
- 产品折扣分析表
- 合同效果评估
- Excel详细报告

### 3. 成本优化（持续）

**优化步骤**:
1. 识别低折扣产品（<30%）
2. 评估采购方式（预留实例/批量续费）
3. 与商务沟通提高折扣
4. 跟踪优化效果

---

## 📞 获取帮助

- **技术文档**: docs/DISCOUNT_ANALYSIS_GUIDE.md
- **集成文档**: WEB_DISCOUNT_INTEGRATION.md
- **项目梳理**: PROJECT_DEEP_ANALYSIS.md
- **CLI帮助**: `./cl analyze discount --help`

---

**最后更新**: 2025-12-15  
**功能状态**: ✅ 已完整集成到Web产品

