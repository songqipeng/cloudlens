# CloudLens æ•°æ®è·å–é€»è¾‘åˆ†æ

**åˆ†ææ—¥æœŸ**: 2026-01-20
**ç›®çš„**: ç¡®è®¤å½“å‰ç¼“å­˜å’Œæ•°æ®è·å–æ¶æ„æ˜¯å¦åˆç†

---

## ğŸ“Š å½“å‰æ•°æ®è·å–æ¶æ„

### å¤šå±‚æ•°æ®è·å–ç­–ç•¥

CloudLens ä½¿ç”¨**ä¸‰å±‚æ•°æ®è·å–ç­–ç•¥**ï¼ŒæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼š

```
1. Redis/MySQLç¼“å­˜ (TTL: 24å°æ—¶)
   â†“ (ç¼“å­˜æœªå‘½ä¸­æˆ–force_refresh=true)
2. MySQLæœ¬åœ°æ•°æ®åº“ (bill_itemsè¡¨)
   â†“ (æ•°æ®åº“æ— æ•°æ®)
3. é˜¿é‡Œäº‘BSS API (å®æ—¶æŸ¥è¯¢)
```

---

## âœ… æ ¸å¿ƒå‡½æ•°åˆ†æ

### 1. `_get_billing_overview_totals()` - è´¦å•æ€»è§ˆè·å–

**ä½ç½®**: `web/backend/api_cost.py:283-380`

**é€»è¾‘æµç¨‹**:

```python
def _get_billing_overview_totals(account_config, billing_cycle, force_refresh=False):
    cache_key = f"billing_overview_totals_{billing_cycle}"
    cache_manager = CacheManager(ttl_seconds=86400)  # 24å°æ—¶TTL

    # ç¬¬1å±‚: æ£€æŸ¥ç¼“å­˜ (Redis/MySQL cacheè¡¨)
    if not force_refresh:
        cached = cache_manager.get(
            resource_type=cache_key,
            account_name=account_config.name
        )
        if cached:
            return cached  # âœ… è¿”å›ç¼“å­˜æ•°æ®ï¼Œä¸è°ƒç”¨API

    # ç¬¬2å±‚: ä»æœ¬åœ°æ•°æ®åº“è¯»å– (bill_itemsè¡¨)
    if not force_refresh:
        db_result = _get_billing_overview_from_db(account_config, billing_cycle)
        if db_result is not None:
            # âœ… æ•°æ®åº“æœ‰æ•°æ®ï¼Œå†™å…¥ç¼“å­˜å¹¶è¿”å›
            cache_manager.set(cache_key, account_config.name, data=[db_result])
            return db_result
        logger.info(f"ğŸ“¡ æ•°æ®åº“ä¸­æ²¡æœ‰è´¦æœŸ {billing_cycle} çš„æ•°æ®ï¼Œé€šè¿‡APIæŸ¥è¯¢")

    # ç¬¬3å±‚: è°ƒç”¨é˜¿é‡Œäº‘BSS APIæŸ¥è¯¢
    items = _bss_query_bill_overview(account_config, billing_cycle)
    # èšåˆè®¡ç®—ï¼Œå†™å…¥ç¼“å­˜
    # ...
```

**å…³é”®ç‰¹æ€§**:
- âœ… **ä¼˜å…ˆè¯»ç¼“å­˜**: `force_refresh=false` æ—¶å…ˆè¯»ç¼“å­˜
- âœ… **å›é€€åˆ°æ•°æ®åº“**: ç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æœ¬åœ°æ•°æ®åº“
- âœ… **æœ€åè°ƒAPI**: æ•°æ®åº“ä¹Ÿæ²¡æœ‰æ—¶æ‰è°ƒç”¨API
- âš ï¸ **é—®é¢˜**: APIæŸ¥è¯¢çš„æ•°æ®**ä¸ä¼šè‡ªåŠ¨å­˜å…¥bill_itemsè¡¨**ï¼Œåªå­˜ç¼“å­˜

---

### 2. `_update_dashboard_summary_cache()` - ä»ªè¡¨ç›˜ç¼“å­˜æ›´æ–°

**ä½ç½®**: `web/backend/api.py:424-550`

**é€»è¾‘æµç¨‹**:

```python
def _update_dashboard_summary_cache(account, account_config, force_refresh=False):
    # è·å–æœ¬æœˆå’Œä¸Šæœˆçš„è´¦å•æ•°æ®
    def get_current_totals():
        # force_refresh=False - ä¼šå…ˆæŸ¥ç¼“å­˜ã€å†æŸ¥æ•°æ®åº“ã€æœ€åè°ƒAPI
        return _get_billing_overview_totals(
            account_config,
            billing_cycle=current_cycle,
            force_refresh=False  # â† ä¸å¼ºåˆ¶åˆ·æ–°
        )

    def get_last_totals():
        totals = _get_billing_overview_totals(
            account_config,
            billing_cycle=last_cycle,
            force_refresh=False  # â† ä¸å¼ºåˆ¶åˆ·æ–°
        )
        # å¦‚æœæ•°æ®åº“æ²¡æœ‰ä¸Šæœˆæ•°æ®ï¼Œå°è¯•é€šè¿‡APIè·å–
        if totals is None or (totals.get("total_pretax", 0) == 0 and
                              totals.get("data_source") == "local_db"):
            return _get_billing_overview_totals(
                account_config,
                billing_cycle=last_cycle,
                force_refresh=True  # â† å¼ºåˆ¶APIæŸ¥è¯¢
            )
        return totals

    # å¹¶è¡Œè·å–
    with ThreadPoolExecutor(max_workers=2) as executor:
        future_current = executor.submit(get_current_totals)
        future_last = executor.submit(get_last_totals)
        current_totals = future_current.result()
        last_totals = future_last.result()

    # è®¡ç®—è¶‹åŠ¿ã€èšåˆæ•°æ®
    # ...

    # å†™å…¥dashboard_summaryç¼“å­˜
    cache_manager.set("dashboard_summary", account, summary_data)
```

**å…³é”®ç‰¹æ€§**:
- âœ… **å¹¶è¡ŒæŸ¥è¯¢**: æœ¬æœˆå’Œä¸Šæœˆæ•°æ®å¹¶è¡Œè·å–ï¼Œæå‡æ€§èƒ½
- âœ… **æ™ºèƒ½å›é€€**: ä¸Šæœˆæ•°æ®ä¸è¶³æ—¶ä¼šå¼ºåˆ¶APIæŸ¥è¯¢
- âš ï¸ **é—®é¢˜**: æ¯æ¬¡åå°æ›´æ–°éƒ½å¯èƒ½è§¦å‘APIè°ƒç”¨ï¼ˆå¦‚æœæ•°æ®åº“æ²¡æœ‰æ•°æ®ï¼‰

---

### 3. æˆ‘æ–°å¢çš„ `get_summary()` - ç›´æ¥æ•°æ®åº“æŸ¥è¯¢

**ä½ç½®**: `web/backend/api_dashboards.py:221-359`

**é€»è¾‘æµç¨‹**:

```python
async def get_summary(account, force_refresh=False):
    cache_manager = CacheManager(ttl_seconds=86400)

    # æ£€æŸ¥ç¼“å­˜
    if not force_refresh:
        cached_result = cache_manager.get("dashboard_summary", account)
        if cached_result:
            return cached_result  # âœ… è¿”å›ç¼“å­˜

    # ç¼“å­˜æœªå‘½ä¸­ï¼Œç›´æ¥ä»æ•°æ®åº“æŸ¥è¯¢ï¼ˆä¸å†è¿”å›"åŠ è½½ä¸­"ï¼‰
    db = get_database_adapter()

    # ç›´æ¥SQLæŸ¥è¯¢æœ¬æœˆå’Œä¸Šæœˆæˆæœ¬
    current_month_query = f"""
        SELECT SUM(payment_amount) as total_cost
        FROM bill_items
        WHERE account_id = '{account}'
        AND billing_cycle = '{current_cycle}'
    """
    current_cost = db.query(current_month_query)[0]['total_cost'] or 0

    # æŸ¥è¯¢ä¸Šæœˆæˆæœ¬ï¼Œè®¡ç®—è¶‹åŠ¿
    # ...

    # åå°å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼ˆè°ƒç”¨ _update_dashboard_summary_cacheï¼‰
    threading.Thread(target=update_cache_task, daemon=True).start()

    return db_result
```

**ç‰¹ç‚¹**:
- âœ… **ç›´æ¥æŸ¥æ•°æ®åº“**: ä¸ç»è¿‡_get_billing_overview_totalsï¼Œä¸ä¼šè§¦å‘API
- âœ… **å¼‚æ­¥æ›´æ–°ç¼“å­˜**: è¿”å›å“åº”ååœ¨åå°æ›´æ–°
- âš ï¸ **é—®é¢˜**: åå°ä»»åŠ¡ä»å¯èƒ½è°ƒç”¨APIï¼ˆå¦‚æœæ•°æ®åº“æ²¡æ•°æ®ï¼‰

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜1: APIè°ƒç”¨é¢‘ç‡è¿‡é«˜ï¼Ÿ

**æ‚¨çš„æ‹…å¿§**: "æ€ä¹ˆæ„Ÿè§‰ç°åœ¨éƒ½æ˜¯å®æ—¶çš„å»è·å–å…¨é‡æ•°æ®å‘¢ï¼Ÿ"

**å®é™…æƒ…å†µåˆ†æ**:

#### åœºæ™¯A: æ•°æ®åº“å·²æœ‰å®Œæ•´æ•°æ®ï¼ˆæ­£å¸¸æƒ…å†µï¼‰

```
ç”¨æˆ·è¯·æ±‚ â†’ æ£€æŸ¥ç¼“å­˜(24h TTL) â†’ ç¼“å­˜å‘½ä¸­ â†’ è¿”å›
                                  â†“ ç¼“å­˜æœªå‘½ä¸­
                           æŸ¥è¯¢bill_itemsè¡¨ â†’ è¿”å›æ•°æ®åº“æ•°æ®
```

**ç»“è®º**: âœ… **ä¸ä¼šè°ƒç”¨API**ï¼Œå®Œå…¨ä»æœ¬åœ°è·å–

#### åœºæ™¯B: æ•°æ®åº“ç¼ºå°‘æŸæœˆæ•°æ®

```
ç”¨æˆ·è¯·æ±‚ â†’ æ£€æŸ¥ç¼“å­˜ â†’ æœªå‘½ä¸­
         â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ æ— æ•°æ®
         â†’ è°ƒç”¨BSS API â†’ è¿”å›APIæ•°æ®ï¼ˆå­˜ç¼“å­˜ï¼Œä½†ä¸å­˜bill_itemsï¼‰
```

**ç»“è®º**: âš ï¸ **ä¼šè°ƒç”¨API**ï¼Œä¸”**ä¸ä¼šæŒä¹…åŒ–åˆ°bill_itemsè¡¨**

#### åœºæ™¯C: ç¼“å­˜è¿‡æœŸåçš„é¦–æ¬¡è¯·æ±‚

```
ç¬¬1å¤©: ç”¨æˆ·è¯·æ±‚ â†’ ç¼“å­˜ â†’ æ•°æ®åº“ â†’ è¿”å› (æ— APIè°ƒç”¨)
ç¬¬2å¤©: ç”¨æˆ·è¯·æ±‚ â†’ ç¼“å­˜è¿‡æœŸ â†’ æ•°æ®åº“ â†’ è¿”å› (æ— APIè°ƒç”¨)
       + åå°ä»»åŠ¡å¼‚æ­¥æ›´æ–°ç¼“å­˜ â†’ æŸ¥æ•°æ®åº“ â†’ æ›´æ–°ç¼“å­˜ (æ— APIè°ƒç”¨)
```

**ç»“è®º**: âœ… **ä»ç„¶ä¸ä¼šè°ƒç”¨API**ï¼ˆå¦‚æœæ•°æ®åº“æœ‰æ•°æ®ï¼‰

---

### é—®é¢˜2: ç¼“å­˜ç­–ç•¥æ˜¯å¦åˆç†ï¼Ÿ

**å½“å‰ç­–ç•¥**:
- **TTL**: 24å°æ—¶
- **å­˜å‚¨**: MySQL `resource_cache` è¡¨
- **èŒƒå›´**: è´¦å•æ€»è§ˆã€èµ„æºåˆ—è¡¨ã€dashboardæ‘˜è¦ç­‰

**åˆ†æ**:

| æ•°æ®ç±»å‹ | æ›´æ–°é¢‘ç‡ | 24hç¼“å­˜ | å»ºè®® |
|---------|---------|---------|------|
| å†å²è´¦å•(å·²å‡ºè´¦) | æ°¸ä¸å˜ | âœ… åˆç† | å¯å»¶é•¿è‡³7å¤©æˆ–æ°¸ä¹… |
| å½“æœˆè´¦å•(æœªå‡ºè´¦) | æ¯å¤©å˜åŒ– | âš ï¸ å¯èƒ½è¿‡æ—¶ | å»ºè®®6-12å°æ—¶ |
| èµ„æºåˆ—è¡¨ | ä¸å®šæœŸå˜åŒ– | âš ï¸ å¯èƒ½è¿‡æ—¶ | å»ºè®®1-6å°æ—¶ |
| Dashboardæ‘˜è¦ | ä¾èµ–è´¦å•+èµ„æº | âœ… åˆç† | ä¿æŒ24å°æ—¶ |

---

### é—®é¢˜3: bill_itemsè¡¨æ•°æ®æ¥æº

**å½“å‰æœºåˆ¶**:

```python
# æ–¹å¼1: æ‰‹åŠ¨è„šæœ¬åŒæ­¥ï¼ˆfetch_2025_bills_v2.pyï¼‰
account = cm.list_accounts()[0]
fetcher = BillFetcher(account, use_database=True)
bills = fetcher.fetch_instance_bill(billing_cycle='2025-01')
fetcher._storage.insert_bill_items(account.name, '2025-01', bills)

# æ–¹å¼2: APIæŸ¥è¯¢ï¼ˆä¸´æ—¶ç¼“å­˜ï¼Œä¸æŒä¹…åŒ–ï¼‰
items = _bss_query_bill_overview(account, billing_cycle)
# âŒ åªå­˜ç¼“å­˜ï¼Œä¸å­˜bill_itemsè¡¨
cache_manager.set(cache_key, account, data=[result])
```

**é—®é¢˜**:
- âš ï¸ APIæŸ¥è¯¢çš„æ•°æ®**ä¸ä¼šè‡ªåŠ¨å…¥åº“bill_items**
- âš ï¸ ä¾èµ–æ‰‹åŠ¨è„šæœ¬å®šæœŸåŒæ­¥
- âš ï¸ æ–°æœˆä»½æ•°æ®éœ€è¦æ‰‹åŠ¨è§¦å‘fetch

---

## ğŸ¯ æ¶æ„è¯„ä¼°

### âœ… ä¼˜ç‚¹

1. **ä¸‰å±‚ç¼“å­˜ç­–ç•¥åˆç†**
   - ç¼“å­˜(å¿«) â†’ æ•°æ®åº“(ä¸­) â†’ API(æ…¢)
   - å¤§éƒ¨åˆ†è¯·æ±‚åœ¨å‰ä¸¤å±‚è§£å†³ï¼Œå‡å°‘APIè°ƒç”¨

2. **æ•°æ®æŒä¹…åŒ–**
   - bill_itemsè¡¨å­˜å‚¨å†å²è´¦å•
   - æ”¯æŒç¦»çº¿åˆ†æã€æŠ¥è¡¨ç”Ÿæˆ

3. **ç¼“å­˜TTLé€‚ä¸­**
   - 24å°æ—¶å¯¹äºè´¦å•æ•°æ®åˆç†
   - å†å²æ•°æ®ä¸ä¼šé¢‘ç¹æŸ¥è¯¢API

4. **å¹¶å‘ä¼˜åŒ–**
   - æœ¬æœˆå’Œä¸Šæœˆæ•°æ®å¹¶è¡ŒæŸ¥è¯¢
   - åå°å¼‚æ­¥æ›´æ–°ç¼“å­˜

### âš ï¸ éœ€è¦ä¼˜åŒ–çš„ç‚¹

#### 1. APIæŸ¥è¯¢ç»“æœæœªæŒä¹…åŒ–

**ç°çŠ¶**:
```python
# _get_billing_overview_totals() ä¸­
items = _bss_query_bill_overview(account, billing_cycle)
# è®¡ç®—æ±‡æ€»...
cache_manager.set(cache_key, account, data=[result])  # â† åªå­˜ç¼“å­˜
# âŒ æ²¡æœ‰å­˜å…¥bill_itemsè¡¨
```

**å»ºè®®**:
```python
# APIæŸ¥è¯¢ååº”è¯¥å…¥åº“
items = _bss_query_bill_overview(account, billing_cycle)

# æŒä¹…åŒ–åˆ°æ•°æ®åº“
bill_storage = BillStorageManager()
bill_storage.insert_bill_items(
    account_id=account.name,
    billing_cycle=billing_cycle,
    items=raw_items  # éœ€è¦åŸå§‹æ˜ç»†æ•°æ®
)

# å†å­˜ç¼“å­˜
cache_manager.set(cache_key, account, data=[result])
```

**å½±å“**:
- âœ… ä¸€æ¬¡APIè°ƒç”¨ï¼Œæ°¸ä¹…å¯ç”¨
- âœ… ç¼“å­˜è¿‡æœŸåä»å¯ä»æ•°æ®åº“è¯»å–
- âœ… å‡å°‘é‡å¤APIè°ƒç”¨

---

#### 2. å½“æœˆæœªå‡ºè´¦æ•°æ®ç¼“å­˜æ—¶é—´è¿‡é•¿

**ç°çŠ¶**: å½“æœˆæ•°æ®ä¹Ÿç”¨24å°æ—¶ç¼“å­˜

**é—®é¢˜**:
- 2026-01-20 10:00 æŸ¥è¯¢ â†’ ç¼“å­˜åˆ° 2026-01-21 10:00
- æœŸé—´æ–°å¢çš„è´¹ç”¨ä¸ä¼šä½“ç°

**å»ºè®®**:
```python
# åŒºåˆ†å·²å‡ºè´¦å’Œæœªå‡ºè´¦
def get_cache_ttl(billing_cycle):
    current_cycle = datetime.now().strftime("%Y-%m")
    if billing_cycle == current_cycle:
        return 6 * 3600  # å½“æœˆ6å°æ—¶
    else:
        return 7 * 24 * 3600  # å†å²æœˆ7å¤©
```

---

#### 3. ç¼ºå°‘è‡ªåŠ¨æ•°æ®åŒæ­¥æœºåˆ¶

**ç°çŠ¶**: ä¾èµ–æ‰‹åŠ¨è„šæœ¬ `fetch_2025_bills_v2.py`

**å»ºè®®**: æ·»åŠ å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒæ­¥

```python
# å®šæ—¶ä»»åŠ¡: æ¯å¤©å‡Œæ™¨2ç‚¹åŒæ­¥æ˜¨å¤©çš„è´¦å•
@scheduler.scheduled_job('cron', hour=2, minute=0)
def sync_yesterday_bills():
    yesterday = (datetime.now() - timedelta(days=1)).strftime("%Y-%m-%d")

    cm = ConfigManager()
    for account in cm.list_accounts():
        fetcher = BillFetcher(account, use_database=True)
        try:
            bills = fetcher.fetch_instance_bill(
                billing_cycle=yesterday[:7],  # YYYY-MM
                start_date=yesterday,
                end_date=yesterday
            )
            fetcher._storage.insert_bill_items(
                account_id=account.name,
                billing_cycle=yesterday[:7],
                items=bills
            )
        except Exception as e:
            logger.error(f"åŒæ­¥è´¦å•å¤±è´¥: {account.name}, {yesterday}, {e}")
```

---

#### 4. Redisæœªå……åˆ†åˆ©ç”¨

**ç°çŠ¶**: ç¼“å­˜å­˜åœ¨MySQL `resource_cache`è¡¨

**MySQLç¼“å­˜çš„é—®é¢˜**:
- æŸ¥è¯¢éœ€è¦SQLè§£æã€ç´¢å¼•æŸ¥æ‰¾
- å¹¶å‘æ€§èƒ½å—é™äºMySQLè¿æ¥æ± 
- ä¸é€‚åˆé«˜é¢‘è¯»å–åœºæ™¯

**å»ºè®®**: åŒå±‚ç¼“å­˜æ¶æ„

```python
class TwoLevelCache:
    def __init__(self):
        self.redis = Redis()  # L1: å†…å­˜ç¼“å­˜ï¼Œ5åˆ†é’ŸTTL
        self.mysql = CacheManager()  # L2: æ•°æ®åº“ç¼“å­˜ï¼Œ24å°æ—¶TTL

    def get(self, key):
        # å…ˆæŸ¥Redis
        value = self.redis.get(key)
        if value:
            return value

        # Redisæœªå‘½ä¸­ï¼ŒæŸ¥MySQLç¼“å­˜
        value = self.mysql.get(key)
        if value:
            # å›å¡«Redis
            self.redis.setex(key, 300, value)  # 5åˆ†é’Ÿ
            return value

        return None
```

**ä¼˜åŠ¿**:
- Rediså¤„ç†é«˜é¢‘è¯·æ±‚
- MySQLä½œä¸ºæŒä¹…åŒ–å¤‡ä»½
- é™ä½MySQLè´Ÿè½½

---

## ğŸ“ æ€»ç»“ä¸å»ºè®®

### å½“å‰æ¶æ„æ€»ç»“

**âœ… æ•´ä½“æ¶æ„åˆç†**:
1. ä¸‰å±‚æ•°æ®è·å–ç­–ç•¥ï¼ˆç¼“å­˜â†’æ•°æ®åº“â†’APIï¼‰ç¬¦åˆæœ€ä½³å®è·µ
2. å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸ä¼šé¢‘ç¹è°ƒç”¨API
3. å†å²æ•°æ®é€šè¿‡bill_itemsè¡¨æŒä¹…åŒ–

**âš ï¸ å­˜åœ¨çš„é—®é¢˜**:
1. APIæŸ¥è¯¢ç»“æœæœªæŒä¹…åŒ–åˆ°bill_itemsï¼Œç¼“å­˜è¿‡æœŸåé‡å¤è°ƒç”¨
2. å½“æœˆæ•°æ®ç¼“å­˜æ—¶é—´è¿‡é•¿ï¼ˆ24hï¼‰ï¼Œå®æ—¶æ€§ä¸è¶³
3. ç¼ºå°‘è‡ªåŠ¨åŒæ­¥æœºåˆ¶ï¼Œä¾èµ–æ‰‹åŠ¨è„šæœ¬
4. Redisæœªå……åˆ†åˆ©ç”¨ï¼Œæ‰€æœ‰ç¼“å­˜éƒ½åœ¨MySQL

---

### ä¼˜åŒ–ä¼˜å…ˆçº§

#### P0 (ç«‹å³ä¼˜åŒ–)

**1. APIæŸ¥è¯¢ç»“æœæŒä¹…åŒ–**
```python
# ä¿®æ”¹ _get_billing_overview_totals()
# åœ¨APIæŸ¥è¯¢åï¼Œå°†åŸå§‹æ•°æ®å­˜å…¥bill_itemsè¡¨
```

**å½±å“**:
- âœ… ä¸€æ¬¡APIè°ƒç”¨ï¼Œæ•°æ®æ°¸ä¹…å¯ç”¨
- âœ… å¤§å¹…å‡å°‘é‡å¤APIè°ƒç”¨
- âš ï¸ éœ€è¦ç¡®ä¿_bss_query_bill_overviewè¿”å›æ˜ç»†æ•°æ®

**å·¥ä½œé‡**: ä¸­ç­‰ï¼ˆéœ€ä¿®æ”¹æ•°æ®æµï¼‰

---

#### P1 (è¿‘æœŸä¼˜åŒ–)

**2. å·®å¼‚åŒ–ç¼“å­˜TTL**
```python
# å½“æœˆ6å°æ—¶ï¼Œå†å²æœˆ7å¤©
cache_ttl = 6*3600 if is_current_month else 7*24*3600
```

**å½±å“**:
- âœ… å½“æœˆæ•°æ®æ›´åŠæ—¶
- âœ… å†å²æ•°æ®å‡å°‘æŸ¥è¯¢

**å·¥ä½œé‡**: å°

---

**3. æ·»åŠ è‡ªåŠ¨åŒæ­¥ä»»åŠ¡**
```python
# å®šæ—¶ä»»åŠ¡æ¯å¤©åŒæ­¥å‰ä¸€å¤©è´¦å•
```

**å½±å“**:
- âœ… æ— éœ€æ‰‹åŠ¨è¿è¡Œè„šæœ¬
- âœ… æ•°æ®è‡ªåŠ¨ä¿æŒæœ€æ–°

**å·¥ä½œé‡**: ä¸­ç­‰ï¼ˆéœ€è¦ä»»åŠ¡è°ƒåº¦æ¡†æ¶ï¼‰

---

#### P2 (é•¿æœŸä¼˜åŒ–)

**4. å¼•å…¥RedisåŒå±‚ç¼“å­˜**
```python
# L1: Redis (5åˆ†é’Ÿ)
# L2: MySQL cache (24å°æ—¶)
```

**å½±å“**:
- âœ… æå‡é«˜é¢‘æŸ¥è¯¢æ€§èƒ½
- âœ… é™ä½MySQLè´Ÿè½½

**å·¥ä½œé‡**: å¤§ï¼ˆéœ€æ¶æ„è°ƒæ•´ï¼‰

---

## ğŸ” æ•°æ®æµç¨‹å›¾

### å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·è¯·æ±‚                            â”‚
â”‚              GET /api/dashboard/summary             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ æ£€æŸ¥MySQLç¼“å­˜         â”‚
        â”‚ (resource_cacheè¡¨)    â”‚
        â”‚ TTL: 24å°æ—¶           â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
             â”‚ Hit         â”‚ Miss
             â†“             â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ è¿”å›   â”‚    â”‚ æŸ¥è¯¢bill_itemsâ”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ è¡¨(MySQL)     â”‚
                      â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                         â”‚ æœ‰æ•°æ®    â”‚ æ— æ•°æ®
                         â†“          â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è¿”å›   â”‚  â”‚ è°ƒç”¨BSS API   â”‚
                    â”‚+å†™ç¼“å­˜ â”‚  â”‚ (å®æ—¶æŸ¥è¯¢)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â†“
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ è¿”å›     â”‚
                                  â”‚ +å†™ç¼“å­˜  â”‚
                                  â”‚ âŒä¸å†™DB â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å»ºè®®æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·è¯·æ±‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ æ£€æŸ¥Redisç¼“å­˜         â”‚
        â”‚ TTL: 5åˆ†é’Ÿ(å½“æœˆ)      â”‚
        â”‚      30åˆ†é’Ÿ(å†å²)     â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
             â”‚ Hit         â”‚ Miss
             â†“             â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ è¿”å›   â”‚    â”‚ æ£€æŸ¥MySQLç¼“å­˜     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ TTL: 6h(å½“æœˆ)     â”‚
                      â”‚      7å¤©(å†å²)    â”‚
                      â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚ Hit      â”‚ Miss
                         â†“          â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è¿”å›   â”‚  â”‚ æŸ¥è¯¢bill_itemsâ”‚
                    â”‚+å†™Redisâ”‚  â”‚ è¡¨            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                                   â”‚ æœ‰       â”‚ æ— 
                                   â†“          â†“
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ è¿”å›    â”‚ â”‚ BSS API  â”‚
                              â”‚+å†™Redis â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                              â”‚+å†™MySQL â”‚      â†“
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ è¿”å›        â”‚
                                          â”‚ +å†™bill_itemsâ”‚
                                          â”‚ +å†™MySQLç¼“å­˜â”‚
                                          â”‚ +å†™Redis    â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å®šæ—¶ä»»åŠ¡(æ¯å¤©2ç‚¹)   â”‚
                    â”‚   åŒæ­¥å‰ä¸€å¤©è´¦å•      â”‚
                    â”‚   â†’ bill_itemsè¡¨     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ†æå®Œæˆ**: 2026-01-20
**ç»“è®º**: æ¶æ„æ•´ä½“åˆç†ï¼Œéœ€è¦P0ä¼˜åŒ–é¡¹ä»¥å‡å°‘APIè°ƒç”¨

